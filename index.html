<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
    <title>å»£å‘Šæ‹›ç‰Œ ERP - V7.85 (ç´”é›²ç«¯ç‰ˆ)</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary: #4338ca; --bg: #f8fafc;
            --text-dark: #1e293b; --text-light: #64748b;
            --green: #10b981; --red: #ef4444; --blue: #3b82f6; --orange: #f59e0b;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        * { box-sizing: border-box; font-family: "Segoe UI", system-ui, sans-serif; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; padding: 15px; background: var(--bg); color: var(--text-dark); font-size: 14px; padding-bottom: 80px; }
        .container { max-width: 1750px; margin: 0 auto; }

        /* Cloud Loading Overlay (æ–°å¢ï¼šé›²ç«¯è®€å–é®ç½©) */
        #cloudLoadingOverlay {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255, 255, 255, 0.85); z-index: 20000;
            justify-content: center; align-items: center; flex-direction: column;
            backdrop-filter: blur(4px);
        }
        .loading-spinner {
            width: 40px; height: 40px; border: 4px solid #e2e8f0;
            border-top: 4px solid var(--primary); border-radius: 50%;
            animation: spin 1s linear infinite; margin-bottom: 15px;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Notification Center */
        .notify-section { display: none; margin-bottom: 20px; animation: slideDown 0.4s ease-out; }
        .notify-card { 
            background: white; border-radius: 8px; padding: 15px; margin-bottom: 10px; 
            box-shadow: var(--shadow); border: 1px solid #e2e8f0; display: flex; align-items: flex-start; gap: 15px;
            position: relative; overflow: hidden;
        }
        .notify-card.overdue { border-left: 5px solid #ef4444; }
        .notify-card.soon { border-left: 5px solid #f59e0b; }
        .notify-icon { font-size: 24px; padding-top: 2px; }
        .notify-content h4 { margin: 0 0 5px 0; font-size: 15px; font-weight: 700; }
        .notify-content ul { margin: 0; padding-left: 20px; color: #475569; font-size: 13px; }
        .notify-action { margin-left: auto; align-self: center; }

        @keyframes slideDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }

        /* Preview Tooltip */
        #party_preview_tooltip {
            position: fixed; z-index: 10001; background: white; border: 1px solid #cbd5e1;
            padding: 12px; border-radius: 10px; box-shadow: 0 10px 25px rgba(0,0,0,0.15);
            pointer-events: none; display: none; min-width: 250px; max-width: 350px; font-size: 13px; line-height: 1.6;
        }
        .preview-title { font-weight: 800; color: var(--primary); border-bottom: 2px solid #f1f5f9; margin-bottom: 8px; padding-bottom: 4px; display: flex; align-items: center; gap: 5px; }
        .hover-info { color: var(--primary); text-decoration: underline dotted; cursor: help; }
        .preview-row { display: flex; justify-content: space-between; border-bottom: 1px dashed #eee; padding: 2px 0; }
        
        /* Header */
        header { display: flex; flex-wrap: wrap; justify-content: space-between; align-items: center; margin-bottom: 20px; background: white; padding: 15px 20px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.03); }
        .brand h2 { margin: 0; font-size: 20px; font-weight: 800; color: #334155; }
        .brand span { background: var(--primary); color: white; padding: 2px 6px; border-radius: 6px; font-size: 11px; margin-left: 5px; vertical-align: middle; }
        
        .sync-status { display: inline-flex; align-items: center; gap: 6px; font-size: 12px; font-weight: 600; background: #f1f5f9; padding: 6px 12px; border-radius: 20px; cursor: pointer; transition: 0.3s; margin-left: 10px; }
        .dot { width: 8px; height: 8px; border-radius: 50%; background: #ccc; }
        .dot.ok { background: #10b981; box-shadow: 0 0 5px #10b981; }
        .dot.sync { background: #f59e0b; animation: pulse 1s infinite; }
        .dot.err { background: #ef4444; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }

        /* Buttons */
        .btn { padding: 8px 14px; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; transition: 0.2s; display: inline-flex; align-items: center; gap: 5px; font-size: 13px; margin-left: 5px; }
        .btn:hover { transform: translateY(-1px); filter: brightness(95%); }
        .btn-primary { background: #4f46e5; color: white; }
        .btn-outline { background: white; border: 1px solid #cbd5e1; color: #475569; }
        .btn-danger { background: #ef4444; color: white; }
        .btn-success { background: #10b981; color: white; }
        .btn-warning { background: #f59e0b; color: white; }
        .btn-purple { background: #8b5cf6; color: white; }
        .btn-blue { background: #3b82f6; color: white; }
        .btn-sm { padding: 4px 8px; font-size: 12px; }
        
        /* Date Quick Buttons */
        .date-btns { display: inline-flex; gap: 2px; margin-left: 5px; }
        .date-btn { padding: 4px 8px; font-size: 11px; border: 1px solid #cbd5e1; background: white; cursor: pointer; border-radius: 4px; color: var(--primary); }
        .date-btn:hover { background: #e0e7ff; }

        /* Tabs */
        .tab-menu { display: flex; gap: 8px; margin-bottom: 20px; overflow-x: auto; padding-bottom: 5px; }
        .tab-btn { padding: 10px 16px; border: none; background: white; color: var(--text-light); font-weight: 600; border-radius: 8px; cursor: pointer; transition: 0.2s; white-space: nowrap; flex-shrink: 0; position: relative; }
        .tab-btn.active { background: var(--primary); color: white; box-shadow: 0 4px 10px rgba(79, 70, 229, 0.3); }
        .tab-content { display: none; animation: fadeIn 0.3s; }
        .tab-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        .tab-badge { position: absolute; top: -3px; right: -3px; background: #ef4444; color: white; border-radius: 50%; width: 18px; height: 18px; display: none; font-size: 10px; text-align: center; line-height: 18px; border: 2px solid white; }

        /* Dashboard */
        .dashboard-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 15px; margin-bottom: 20px; }
        .kpi-card { padding: 20px; border-radius: 16px; color: white; position: relative; overflow: hidden; box-shadow: 0 8px 20px rgba(0,0,0,0.1); }
        .kpi-card h3 { margin: 0 0 5px 0; font-size: 13px; opacity: 0.9; text-transform: uppercase; letter-spacing: 1px; }
        .kpi-card .val { font-size: 28px; font-weight: 800; margin: 0; }
        .bg-g-green { background: linear-gradient(135deg, #10b981, #059669); }
        .bg-g-red { background: linear-gradient(135deg, #ef4444, #b91c1c); }
        .bg-g-orange { background: linear-gradient(135deg, #f59e0b, #d97706); }
        .bg-g-purple { background: linear-gradient(135deg, #8b5cf6, #6d28d9); }
        .bg-g-blue { background: linear-gradient(135deg, #3b82f6, #1d4ed8); }

        .card { background: white; padding: 20px; border-radius: 12px; margin-bottom: 15px; box-shadow: 0 2px 10px rgba(0,0,0,0.02); border: 1px solid #e2e8f0; }
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 12px; align-items: end; }
        .form-group { display: flex; flex-direction: column; }
        label { font-size: 12px; font-weight: 700; color: var(--text-light); margin-bottom: 5px; }
        input, select { padding: 10px; border: 1px solid #cbd5e1; border-radius: 8px; font-size: 14px; background: #f8fafc; transition: 0.2s; width: 100%; }
        
        .table-responsive { overflow-x: auto; border-radius: 12px; border: 1px solid #e2e8f0; background: white; }
        table { width: 100%; border-collapse: collapse; min-width: 800px; }
        th { background: #f1f5f9; padding: 12px; text-align: left; font-size: 12px; font-weight: 700; color: var(--text-light); border-bottom: 2px solid #e2e8f0; white-space: nowrap; cursor: pointer; user-select: none; }
        th:hover { background-color: #e2e8f0; }
        td { padding: 12px; border-bottom: 1px solid #e2e8f0; vertical-align: top; }
        tbody tr:nth-child(even) { background-color: #f8fafc; }
        tbody tr:nth-child(odd) { background-color: #ffffff; }

        .badge { padding: 3px 8px; border-radius: 6px; font-size: 11px; font-weight: 700; display: inline-block; white-space: nowrap; }
        .b-green { background: #dcfce7; color: #14532d; }
        .b-red { background: #fee2e2; color: #7f1d1d; }
        .b-blue { background: #dbeafe; color: #1e3a8a; }
        .b-gray { background: #f1f5f9; color: #475569; }

        .filter-bar { background: #e0e7ff; padding: 15px; border-radius: 8px; margin-bottom: 15px; display: flex; gap: 10px; align-items: flex-end; border: 1px solid #c7d2fe; flex-wrap: wrap; }
        .filter-bar h5 { width: 100%; margin: 0 0 5px 0; font-size: 12px; color: var(--primary); }
        
        .bank-history { max-height: 120px; overflow-y: auto; background: #f8fafc; padding: 10px; border-radius: 8px; border: 1px solid #e2e8f0; margin-top: 10px; font-size: 12px; color: #64748b; }
        .bank-item { display: flex; justify-content: space-between; padding: 5px 0; border-bottom: 1px dashed #cbd5e1; }
        .sub-item { font-size: 12px; padding: 2px 0; border-bottom: 1px dashed #eee; color: #555; }
        .hidden { display: none; }

        .report-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; }
        .chart-container { position: relative; height: 300px; width: 100%; margin-bottom: 10px; }
        .rpt-table th { background: #e0e7ff; color: #1e3a8a; }
        .rpt-row:hover { background: #f0fdf4; }
        
        /* Modal */
        .modal { display: none; position: fixed; z-index: 9999; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); backdrop-filter: blur(2px); justify-content: center; align-items: center; }
        .modal-content { background: white; padding: 30px; width: 95%; max-width: 900px; border-radius: 12px; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25); position: relative; max-height: 90vh; overflow-y: auto; }
        .close { position: absolute; right: 20px; top: 20px; font-size: 24px; cursor: pointer; color: #94a3b8; }
        
        /* Status Button */
        .status-btn { border: 1px solid #ccc; padding: 4px 10px; border-radius: 4px; cursor: pointer; font-size: 12px; font-weight: bold; transition: 0.2s; min-width: 70px; }
        .status-btn:hover { opacity: 0.8; transform: scale(1.05); }
        .st-paid { background: #dcfce7; color: #166534; border-color: #bbf7d0; }
        .st-unpaid { background: #fee2e2; color: #991b1b; border-color: #fca5a5; }
        .st-deposit { background: #dbeafe; color: #1e40af; border-color: #bfdbfe; }
        .stmt-bank-sel { padding: 4px; border: 1px solid #ccc; border-radius: 4px; font-size: 12px; max-width: 100px; }
        
        #error_rescue { display:none; position:fixed; bottom:0; left:0; width:100%; background:#7f1d1d; color:white; padding:20px; text-align:center; z-index:10000; }
        
        /* Prepaid & Items */
        .prepaid-row { display: flex; justify-content: space-between; align-items: center; padding: 8px; border-bottom: 1px solid #eee; }
        .prepaid-bal { font-weight: bold; font-size: 16px; }
        .is-neg { color: red; }
        .prepaid-badge { background:#ffedd5; color:#c2410c; border:1px solid #fdba74; font-size:10px; padding:2px 5px; border-radius:4px; margin-left:5px; vertical-align:middle; display:inline-block; }
        
        /* Item Grid (With Talent) */
        .item-grid { display: grid; grid-template-columns: 2fr 1fr 0.8fr 0.8fr 0.8fr 0.8fr 1fr 1fr auto; gap: 8px; align-items: center; margin-bottom: 8px; }
        
        /* Subcontractor Grid (With Note) */
        .sub-grid { display: grid; grid-template-columns: 1.5fr 1fr 0.8fr 1.2fr 1.5fr auto; gap: 8px; align-items: center; margin-bottom: 5px; }

        @media (max-width: 1024px) {
            .item-grid { grid-template-columns: 1fr 1fr 1fr 1fr; gap: 5px; border-bottom: 1px dashed #ccc; padding-bottom: 10px; }
            .item-grid input:nth-child(1) { grid-column: span 4; } /* Name */
            .item-grid input:nth-child(2) { grid-column: span 2; } /* Spec */
            .item-grid button { grid-column: span 4; margin-top: 5px; }
            
            .sub-grid { grid-template-columns: 1fr 1fr; }
            .sub-grid button { grid-column: span 2; }
        }
    </style>
</head>
<body>

<div id="cloudLoadingOverlay">
    <div class="loading-spinner"></div>
    <div id="cloudLoadingText" style="font-weight:bold; color:#1e293b; font-size:18px;">â˜ï¸ è³‡æ–™åŒæ­¥ä¸­...</div>
</div>

<div id="party_preview_tooltip"></div>

<div id="error_rescue">
    <h3>âš ï¸ ç³»çµ±åµæ¸¬åˆ°éŒ¯èª¤</h3>
    <p>ç³»çµ±å·²å˜—è©¦è‡ªå‹•ä¿®å¾©ã€‚è‹¥ä»å¡ä½ï¼Œè«‹é»æ“Šä¸‹æ–¹æŒ‰éˆ•é‡ç½®ç³»çµ± (è³‡æ–™å°‡æ¸…ç©º)ã€‚</p>
    <button class="btn btn-outline" style="background:white; color:red;" onclick="hardReset()">ğŸš¨ å¼·åˆ¶é‡ç½®</button>
</div>

<div id="configModal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeConfig()">&times;</span>
        <h2 style="margin-top:0">â˜ï¸ é›²ç«¯è¨­å®š</h2>
        <input type="text" id="api_url_input" placeholder="https://script.google.com/..." style="width:100%; margin-bottom:10px;">
        <div style="display:flex; gap:10px; margin-bottom:20px;">
            <button class="btn btn-primary" onclick="testConnection()">é€£ç·šæ¸¬è©¦</button>
            <button class="btn btn-outline" onclick="closeConfig()">é—œé–‰</button>
        </div>
        <hr style="border:0; border-top:1px dashed #ccc; margin:20px 0;">
        <button class="btn btn-danger" onclick="hardReset()">ğŸ”„ é‡ç½®ç³»çµ±</button>
    </div>
</div>

<div id="bankModal" class="modal">
    <div class="modal-content" style="max-width: 500px;">
        <span class="close" onclick="closeBankModal()">&times;</span>
        <h2 style="margin-top:0">ğŸ’° è³‡é‡‘æ“ä½œ (å­˜/æ/è½‰)</h2>
        <form onsubmit="event.preventDefault(); saveBankTrans();">
            <div class="form-group">
                <label>æ—¥æœŸ</label>
                <input type="date" id="bt_date" required>
            </div>
            <div class="form-group">
                <label>æ“ä½œé¡å‹</label>
                <select id="bt_type" onchange="toggleBankTransFields()">
                    <option value="deposit">â• å­˜æ¬¾ (æ”¶å…¥)</option>
                    <option value="withdraw">â– ææ¬¾ (æ”¯å‡º)</option>
                    <option value="transfer">ğŸ”„ å…§éƒ¨è½‰å¸³ (äº’è½‰)</option>
                </select>
            </div>
            <div class="form-group"><label id="lbl_source">å­˜å…¥å¸³æˆ¶</label><select id="bt_source" class="bank-sel"></select></div>
            <div class="form-group hidden" id="div_target"><label>è½‰å…¥å¸³æˆ¶</label><select id="bt_target" class="bank-sel"></select></div>
            <div class="form-group"><label>é‡‘é¡</label><input type="number" id="bt_amt" required placeholder="è¼¸å…¥é‡‘é¡"></div>
            <div class="form-group"><label>å‚™è¨»</label><input type="text" id="bt_note" placeholder="å‚™è¨»"></div>
            <div style="margin-top:20px;"><button class="btn btn-primary" style="width:100%">ç¢ºèªåŸ·è¡Œ</button></div>
        </form>
    </div>
</div>

<div id="prepaidModal" class="modal">
    <div class="modal-content" style="max-width: 800px;">
        <span class="close" onclick="document.getElementById('prepaidModal').style.display='none'">&times;</span>
        <h2 style="margin-top:0">ğŸ­ å» å•†é ä»˜é‡‘ç®¡ç†</h2>
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:20px;">
            <div style="background:#f8fafc; padding:15px; border-radius:8px; border:1px solid #e2e8f0; max-height:400px; overflow-y:auto;">
                <h4 style="margin-top:0; color:var(--primary);">ç¾æœ‰é ä»˜é¤˜é¡åˆ—è¡¨</h4>
                <div id="prepaid_list_div"></div>
            </div>
            <div>
                <h4 style="margin-top:0; color:#059669;">â• æ–°å¢é ä»˜ (å„²å€¼)</h4>
                <form onsubmit="event.preventDefault(); doPrepaidTopUp();">
                    <div class="form-group">
                        <label>é¸æ“‡/è¼¸å…¥å» å•†</label>
                        <input type="text" id="pp_vendor" list="vlist_prepaid" required placeholder="è¼¸å…¥å» å•†åç¨±...">
                        <datalist id="vlist_prepaid"></datalist>
                    </div>
                    <div class="form-group">
                        <label>è³‡é‡‘ä¾†æº (æ‰£æ¬¾å¸³æˆ¶)</label>
                        <select id="pp_source_bank" class="bank-sel"></select>
                    </div>
                    <div class="form-group">
                        <label>å„²å€¼é‡‘é¡</label>
                        <input type="number" id="pp_amt" required placeholder="ä¾‹å¦‚: 10000">
                    </div>
                    <div class="form-group">
                        <label>å‚™è¨»</label>
                        <input type="text" id="pp_note" placeholder="ä¾‹å¦‚: æœˆåº•å…ˆçµã€ææ–™é ä»˜æ¬¾">
                    </div>
                    <button class="btn btn-success" style="width:100; margin-top:15px;">ğŸ’° ç¢ºèªè½‰å¸³å„²å€¼</button>
                </form>
                <div style="margin-top:20px; padding:10px; background:#fff7ed; font-size:12px; border:1px solid #ffedd5; color:#c2410c; border-radius:6px;">
                    ğŸ’¡ <b>èªªæ˜ï¼š</b><br>
                    1. å„²å€¼å¾Œï¼Œè³‡é‡‘æœƒè½‰å…¥è©²å» å•†çš„ã€Œé ä»˜å¸³æˆ¶ã€ã€‚<br>
                    2. è‹¥å» å•†å·²è¨­å®šç‚ºã€Œé ä»˜å» å•†ã€ï¼Œè¨‚å–®ç™¼åŒ…æ™‚å°‡<b>è‡ªå‹•</b>å¾æ­¤é¤˜é¡æ‰£é™¤ã€‚
                </div>
            </div>
        </div>
    </div>
</div>

<div id="invModal" class="modal">
    <div class="modal-content" style="max-width: 500px;">
        <span class="close" onclick="document.getElementById('invModal').style.display='none'">&times;</span>
        <h2 style="margin-top:0">ğŸ§¾ ç™¼ç¥¨è™Ÿç¢¼ç®¡ç†</h2>
        <div style="background:#f0f9ff; padding:15px; border-radius:8px; margin-bottom:15px;">
            <label style="color:#0369a1; font-weight:bold;">ç›®å‰å‰©é¤˜å¼µæ•¸ï¼š</label>
            <span id="inv_pool_count" style="font-size:24px; font-weight:bold; color:#0284c7;">0</span> å¼µ
            <div id="inv_next_val" style="font-size:12px; color:#555; margin-top:5px;">ä¸‹ä¸€å¼µ: ç„¡</div>
        </div>
        <div class="form-grid">
            <div class="form-group"><label>å­—è»Œ</label><input type="text" id="inv_prefix" placeholder="AB" maxlength="2" style="text-transform:uppercase;"></div>
            <div class="form-group"><label>èµ·å§‹è™Ÿç¢¼</label><input type="number" id="inv_start" placeholder="00000100"></div>
            <div class="form-group"><label>çµæŸè™Ÿç¢¼</label><input type="number" id="inv_end" placeholder="00000200"></div>
        </div>
        <button class="btn btn-purple" style="width:100%; margin-top:15px;" onclick="addInvoiceRange()">â• åŒ¯å…¥ç™¼ç¥¨è™Ÿç¢¼</button>
        <button class="btn btn-danger" style="width:100%; margin-top:10px;" onclick="clearInvoicePool()">ğŸ—‘ï¸ æ¸…ç©ºæ‰€æœ‰åº«å­˜</button>
    </div>
</div>

<div id="statementModal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeModal()">&times;</span>
        <h2 id="modal_title" style="margin-top:0">å°å¸³å–®</h2>
        <div id="modal_info" style="color:var(--text-light); margin-bottom:15px;"></div>
        <div style="text-align:right; margin-bottom:15px; display:flex; gap:5px; justify-content:flex-end; align-items:center;">
            <select id="modal_filter" style="padding:6px; border-radius:4px; border:1px solid #ddd;" onchange="refreshStatement()"></select>
            <span style="color:#ddd">|</span>
            <input type="date" id="modal_start" style="padding:6px; border-radius:4px; border:1px solid #ddd; width:auto;"> ~ 
            <input type="date" id="modal_end" style="padding:6px; border-radius:4px; border:1px solid #ddd; width:auto;">
            <button class="btn btn-primary btn-sm" onclick="refreshStatement()">æŸ¥è©¢</button>
        </div>
        <div class="table-responsive"><table id="modal_table"><thead></thead><tbody></tbody></table></div>
        <div id="modal_summary" style="margin-top:15px; padding:15px; background:#f1f5f9; border-radius:8px; font-weight:700; text-align:right; color:var(--primary); font-size:16px;"></div>
    </div>
</div>

<div class="container">
    <header>
        <div style="display:flex; align-items:center;">
            <div class="brand">
                <h2>è­½å¯Œåœ‹éš›æœƒè¨ˆç³»çµ± <span>V7.85 (ç´”é›²ç«¯ç‰ˆ)</span></h2>
                <div id="clock" style="font-size:12px; color:#64748b; margin-top:2px;"></div>
            </div>
            <div class="sync-status" onclick="openConfig()" title="é»æ“Šè¨­å®šé›²ç«¯">
                <div id="status_dot" class="dot"></div>
                <span id="status_text">å¾…æ©Ÿ</span>
            </div>
        </div>
        <div style="display:flex; gap:5px; flex-wrap:wrap;">
            <button class="btn btn-purple" onclick="openInvModal()">ğŸ§¾ ç™¼ç¥¨ç®¡ç†</button>
            <button class="btn btn-outline" onclick="syncData(true)">ğŸ”„ é‡æ–°æ•´ç†</button>
            <button class="btn btn-outline" onclick="exportData()">ğŸ“¥ å‚™ä»½</button>
            <input type="file" id="importFile" style="display:none" onchange="importData(this)">
            <button class="btn btn-outline" onclick="document.getElementById('importFile').click()">ğŸ“¤ é‚„åŸ (å°å¿ƒè¦†è“‹)</button>
        </div>
    </header>

    <div class="tab-menu">
        <button class="tab-btn active" onclick="switchTab('dashboard')">ğŸ“Š å„€è¡¨æ¿</button>
        <button class="tab-btn" onclick="switchTab('reports')">ğŸ“ˆ ç¶“ç‡Ÿå ±è¡¨</button>
        <button class="tab-btn" onclick="switchTab('orders')">ğŸ“ è¨‚å–®</button>
        <button class="tab-btn" onclick="switchTab('recurring')">ğŸ“… å›ºå®šæ”¯å‡º <span id="recur_badge" class="tab-badge">0</span></button>
        <button class="tab-btn" onclick="switchTab('expenses')">ğŸ’¸ æµ®å‹•æ”¯å‡º</button>
        <button class="tab-btn" onclick="switchTab('parties')">ğŸ‘¥ åå–®ç®¡ç†</button>
        <button class="tab-btn" onclick="switchTab('banks')">ğŸ¦ éŠ€è¡Œ/è³‡é‡‘</button>
    </div>

    <div id="dashboard" class="tab-content active">
        <div id="notify_center" class="notify-section"></div>
        <div class="dashboard-grid">
            <div class="kpi-card bg-g-green"><h3>æœ¬æœˆæ·¨ç¾é‡‘æµ</h3><div class="val" id="kpi_cash">$0</div></div>
            <div class="kpi-card bg-g-purple"><h3>é ä¼°æ‡‰ç¹³ç¨…é¡</h3><div class="val" id="kpi_vat">$0</div></div>
            <div class="kpi-card bg-g-red"><h3>æ‡‰æ”¶å¸³æ¬¾ (AR)</h3><div class="val" id="kpi_ar">$0</div></div>
            <div class="kpi-card bg-g-orange"><h3>æ‡‰ä»˜å¸³æ¬¾ (AP)</h3><div class="val" id="kpi_ap">$0</div></div>
        </div>
        <div id="inv_alert_box" style="display:none; background:#fee2e2; color:#b91c1c; padding:15px; border-radius:8px; border:1px solid #fca5a5; margin-top:20px; font-weight:bold; text-align:center;">
            âš ï¸ ç™¼ç¥¨è™Ÿç¢¼åº«å­˜ä¸è¶³ï¼Œè«‹è‡³ä¸Šæ–¹ã€Œç™¼ç¥¨ç®¡ç†ã€è£œå……ï¼
        </div>
    </div>
    
    <div id="reports" class="tab-content">
        <div class="report-grid">
            <div class="card"><h4>ğŸ“Š æ”¶æ¬¾ç‹€æ…‹</h4><div class="chart-container"><canvas id="c_pie"></canvas></div></div>
            <div class="card"><h4>ğŸ“ˆ æ”¶æ”¯å°æ¯”</h4><div class="chart-container"><canvas id="c_bar"></canvas></div></div>
            <div class="card"><h4>ğŸ’¹ è³‡é‡‘æµè¶¨å‹¢</h4><div class="chart-container"><canvas id="c_line"></canvas></div></div>
            <div class="card"><h4>ğŸ† å®¢æˆ¶è²¢ç»æ’è¡Œ</h4><div class="chart-container"><canvas id="c_cust"></canvas></div></div>
        </div>
        <div class="card">
            <h4>ğŸ“… æœˆåº¦æç›Šè©³æƒ…è¡¨</h4>
            <div class="table-responsive" style="margin-bottom:15px;">
                <table class="rpt-table" id="rpt_month_table"><thead><tr><th>æœˆä»½</th><th>ç¸½ç‡Ÿæ”¶</th><th>ç¸½æ”¯å‡º</th><th>æ·¨åˆ©</th><th>æ¯›åˆ©ç‡</th></tr></thead><tbody></tbody></table>
            </div>
            <button class="btn btn-success" onclick="exportExcel()">ğŸ“¥ ä¸‹è¼‰ Excel</button>
        </div>
    </div>

    <div id="orders" class="tab-content">
        <div class="card">
            <h4>â• æ–°å¢è¨‚å–®</h4>
            <datalist id="productList"></datalist>

            <form id="orderForm" onsubmit="event.preventDefault(); saveOrder();">
                <input type="hidden" id="o_edit_id">
                <div class="form-grid">
                    <div class="form-group"><label>æ—¥æœŸ</label><input type="date" id="o_date" required></div>
                    <div class="form-group"><label>å°ˆæ¡ˆ</label><input type="text" id="o_proj" required></div>
                    <div class="form-group">
                        <label>å®¢æˆ¶</label>
                        <input type="text" id="o_cust" list="clist" placeholder="é¸å–æˆ–è¼¸å…¥æ–°å®¢æˆ¶" required onchange="fillCustInfo(this)">
                        <datalist id="clist"></datalist>
                    </div>
                    <div class="form-group"><label>è¯çµ¡äºº</label><input type="text" id="o_contact" placeholder="å¤šä½è«‹ç”¨é€—è™Ÿéš”é–‹"></div>
                    <div class="form-group"><label>è¯çµ¡é›»è©±</label><input type="text" id="o_phone" placeholder="é›»è©± / æ‰‹æ©Ÿ"></div>
                    <div class="form-group" style="grid-column: span 2;"><label>é€è²¨/æ–½å·¥åœ°å€</label><input type="text" id="o_addr" placeholder="åœ°å€"></div>
                    
                    <div class="form-group"><label>ç™¼ç¥¨é¡å‹</label><select id="o_invoice"><option value="ç„¡">ç„¡</option><option value="äºŒè¯">äºŒè¯</option><option value="ä¸‰è¯">ä¸‰è¯</option></select></div>
                    <div class="form-group"><label>ç™¼ç¥¨è™Ÿç¢¼</label><input type="text" id="o_inv_num" placeholder="è‡ªå‹•å¸¶å…¥ æˆ– æ‰‹å‹•è¼¸å…¥"></div>
                </div>

                <div style="margin-top:15px; background:#eff6ff; padding:15px; border-radius:8px; border:1px solid #bfdbfe; margin-bottom:15px;">
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <label style="color:#1e40af; font-weight:bold;">ğŸ“¦ è¨‚å–®æ˜ç´° (æ‰æ•¸è¨ˆåƒ¹)</label>
                        <span style="font-size:11px; color:#64748b;">( 1æ‰ = 30cm x 30cm )</span>
                    </div>
                    <div id="items_area" style="margin-top:10px;"></div>
                    <button type="button" class="btn btn-blue btn-sm" onclick="addItemRow()">+ æ–°å¢é …ç›®</button>
                </div>

                <div class="form-grid">
                    <div class="form-group"><label>æœªç¨…</label><input type="number" id="o_base" oninput="calcTax('o','base')"></div>
                    <div class="form-group"><label>ç¨…é‡‘</label><input type="number" id="o_tax"></div>
                    <div class="form-group"><label>ç¸½åƒ¹ (å«ç¨…)</label><input type="number" id="o_price" oninput="calcTax('o','total')" required></div>
                    <div class="form-group"><label>è¨‚é‡‘</label><input type="number" id="o_deposit" value="0"></div>
                    <div class="form-group"><label>è«‹æ¬¾</label><select id="o_inv"><option>æœªè«‹æ¬¾</option><option>å·²è«‹æ¬¾</option></select></div>
                    <div class="form-group"><label>æ”¶æ¬¾</label><select id="o_pay"><option value="æœªæ”¶æ¬¾">æœªæ”¶æ¬¾</option><option value="å·²æ”¶è¨‚é‡‘">å·²æ”¶è¨‚é‡‘</option><option value="å·²æ”¶å…¨æ¬¾">å·²æ”¶å…¨æ¬¾</option></select></div>
                    <div class="form-group"><label>å…¥å¸³éŠ€è¡Œ</label><select id="o_bank" class="bank-sel"></select></div>
                    <div class="form-group" style="grid-column: span 2;"><label>å‚™è¨»äº‹é …</label><input type="text" id="o_note" placeholder="è¨‚å–®ç‰¹æ®Šå‚™è¨»..."></div>
                </div>
                <div style="margin-top:15px; background:#f0fdf4; padding:15px; border-radius:8px; border:1px solid #bbf7d0;">
                    <label style="color:#166534; font-weight:bold;">ç™¼åŒ…å» å•† (æˆæœ¬)</label>
                    <div style="margin-bottom:8px; font-size:12px; color:#15803d;">ğŸ’¡ å°æ’‡æ­¥ï¼šè‹¥é¸æ“‡å·²è¨­å®šç‚ºã€Œé ä»˜å» å•†ã€çš„å°è±¡ï¼Œä»˜æ¬¾éŠ€è¡Œå°‡è‡ªå‹•åˆ‡æ›ç‚ºã€Œé ä»˜æ‰£æ¬¾ã€ã€‚</div>
                    <div id="sub_area" style="margin-top:10px;"></div>
                    <button type="button" class="btn btn-outline btn-sm" onclick="addSubRow()">+ å¢åŠ å» å•†</button>
                </div>
                <div style="margin-top:20px; display:flex; gap:10px;"><button type="submit" class="btn btn-primary" style="flex:1">å„²å­˜è¨‚å–®</button></div>
            </form>
        </div>
        
        <div class="filter-bar">
            <h5>ğŸ” è¨‚å–®ç¯©é¸</h5>
            <div class="form-group"><select id="fo_inv" onchange="renderOrders()"><option value="">è«‹æ¬¾(å…¨)</option><option value="å·²è«‹æ¬¾">å·²è«‹æ¬¾</option><option value="æœªè«‹æ¬¾">æœªè«‹æ¬¾</option></select></div>
<div class="form-group">
    <select id="fo_inv_status" onchange="renderOrders()" style="min-width: 110px;">
        <option value="">é–‹ç¥¨ç‹€æ…‹(å…¨)</option>
        <option value="å·²é–‹">å·²é–‹ç™¼ç¥¨ (æœ‰è™Ÿç¢¼)</option>
        <option value="æœªé–‹">æœªé–‹ç™¼ç¥¨ (ç„¡è™Ÿç¢¼)</option>
    </select>
</div>
            <div class="form-group"><select id="fo_pay" onchange="renderOrders()"><option value="">æ”¶æ¬¾(å…¨)</option><option value="æœªæ”¶æ¬¾">æœªæ”¶æ¬¾(å«è¨‚)</option><option value="å·²æ”¶æ¬¾">å·²æ”¶æ¬¾</option></select></div>
            
            <div class="form-group">
                <select id="fo_sub_status" onchange="renderOrders()" style="min-width:110px;">
                    <option value="">å» å•†æ¬¾(å…¨)</option>
                    <option value="å·²æ”¯ä»˜">å·²æ”¯ä»˜ (å…¨æ¸…)</option>
                    <option value="æœªæ”¯ä»˜">æœªæ”¯ä»˜ (æœ‰æ¬ )</option>
                </select>
            </div>

            <div class="form-group"><input type="date" id="fo_start" onchange="renderOrders()"></div>
            <div class="form-group"><input type="date" id="fo_end" onchange="renderOrders()"></div>
            <div class="form-group" style="padding-bottom:10px;">
                <div class="date-btns"><button class="date-btn" onclick="setDateRange('month', 'fo')">æœ¬æœˆ</button><button class="date-btn" onclick="setDateRange('quarter', 'fo')">æœ¬å­£</button><button class="date-btn" onclick="setDateRange('year', 'fo')">æœ¬å¹´</button></div>
            </div>
            <div class="form-group"><input type="text" id="s_key_o" placeholder="æœå°‹(å«é›»è©±/åœ°å€)..." oninput="renderOrders()"></div>
        </div>
        <div id="order_search_summary" style="background:#e0f2fe; padding:10px 15px; border-radius:8px; margin-bottom:15px; font-weight:bold; color:#0369a1; border:1px solid #bae6fd;">ğŸ“Š æœå°‹å°è¨ˆ: è«‹è¼¸å…¥æ¢ä»¶</div>
        <div class="table-responsive">
            <table id="o_table">
                <thead><tr><th onclick="sortOrders('date')">æ—¥æœŸ <span id="sort_date">â–¼</span></th><th onclick="sortOrders('proj')">å°ˆæ¡ˆ/å®¢æˆ¶/é …ç›® <span id="sort_proj"></span></th><th onclick="sortOrders('invNum')">ç™¼ç¥¨ <span id="sort_invNum"></span></th><th onclick="sortOrders('price')">é‡‘é¡/åˆ©æ½¤ <span id="sort_price"></span></th><th>ç‹€æ…‹</th><th>ç™¼åŒ…æ˜ç´°</th><th>æ“ä½œ</th></tr></thead>
                <tbody id="o_list"></tbody>
            </table>
        </div>
    </div>

    <div id="recurring" class="tab-content">
        <div class="card">
            <h4>ğŸ“… å›ºå®šæ”¯å‡º</h4>
            <form id="recurForm" onsubmit="event.preventDefault(); saveRecurring();">
                <input type="hidden" id="r_edit_id">
                <div class="form-grid">
                    <input type="text" id="r_title" placeholder="é …ç›®" required>
                    <input type="number" id="r_amt" placeholder="é‡‘é¡" required>
                    <select id="r_bank" class="bank-sel"></select>
                    <select id="r_period"><option value="monthly">æ¯æœˆ</option><option value="yearly">æ¯å¹´</option></select>
                    <input type="number" id="r_cycle_val" placeholder="æ‰£æ¬¾æ—¥" required>
                    <input type="date" id="r_start" required><input type="date" id="r_end" required>
                    <input type="text" id="r_note" placeholder="å‚™è¨»">
                    <button class="btn btn-primary">å„²å­˜</button>
                </div>
            </form>
        </div>
        <div class="filter-bar">
            <h5>ğŸ” åˆç´„ç¯©é¸</h5>
            <div class="form-group"><input type="date" id="fr_start" onchange="renderRecurring()"></div>
            <div class="form-group"><input type="date" id="fr_end" onchange="renderRecurring()"></div>
            <div class="form-group"><input type="text" id="s_key_r" placeholder="é …ç›®..." oninput="renderRecurring()"></div>
        </div>
        <div class="table-responsive">
            <table>
                <thead>
                    <tr>
                        <th onclick="sortRecurring('title')">é …ç›® <span id="sort_r_title"></span></th>
                        <th onclick="sortRecurring('bank')">éŠ€è¡Œ/å‚™è¨» <span id="sort_r_bank"></span></th>
                        <th onclick="sortRecurring('amt')">é‡‘é¡ <span id="sort_r_amt"></span></th>
                        <th onclick="sortRecurring('nextDate')">æœªä¾† 5 æœŸ (é»æ“Šæ”¯ä»˜) <span id="sort_r_nextDate">â–¼</span></th>
                        <th>æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody id="r_list"></tbody>
            </table>
        </div>
    </div>

    <div id="expenses" class="tab-content">
        <div class="card">
            <h4>ğŸ’¸ æµ®å‹•æ”¯å‡º</h4>
            <form id="expForm" onsubmit="event.preventDefault(); saveExpense();">
                <input type="hidden" id="e_edit_id">
                <div class="form-grid">
                    <input type="date" id="e_date" required>
                    <input type="text" id="e_note" placeholder="ç›®çš„" required>
                    <input type="text" id="e_target" placeholder="å°è±¡" list="vlist"><datalist id="vlist"></datalist>
                    <input type="number" id="e_amt" placeholder="ç¸½é¡" required oninput="calcTax('e','total')">
                    <input type="number" id="e_base" placeholder="æœªç¨…" oninput="calcTax('e','base')">
                    <input type="number" id="e_tax" placeholder="ç¨…é‡‘">
                    <select id="e_bank" class="bank-sel"></select>
                    <select id="e_status"><option value="å·²æ”¯ä»˜">å·²æ”¯ä»˜</option><option value="æœªæ”¯ä»˜">æœªæ”¯ä»˜</option></select>
                    <input type="text" id="e_remark" placeholder="å‚™è¨»">
                    <button class="btn btn-primary">å„²å­˜</button>
                </div>
            </form>
        </div>
        <div class="filter-bar">
            <h5>ğŸ” æ”¯å‡ºç¯©é¸</h5>
            <div class="form-group"><select id="fe_status" onchange="renderExpenses()"><option value="">å…¨éƒ¨</option><option value="å·²æ”¯ä»˜">å·²æ”¯ä»˜</option><option value="æœªæ”¯ä»˜">æœªæ”¯ä»˜</option></select></div>
            <div class="form-group"><input type="date" id="fe_start" onchange="renderExpenses()"></div>
            <div class="form-group"><input type="date" id="fe_end" onchange="renderExpenses()"></div>
            <div class="form-group"><input type="text" id="s_key_e" placeholder="ç›®çš„/å°è±¡..." oninput="renderExpenses()"></div>
        </div>
        <div class="table-responsive">
            <table>
                <thead>
                    <tr>
                        <th onclick="sortExpenses('date')">æ—¥æœŸ <span id="sort_e_date">â–¼</span></th>
                        <th onclick="sortExpenses('note')">ç›®çš„ <span id="sort_e_note"></span></th>
                        <th onclick="sortExpenses('target')">å°è±¡ <span id="sort_e_target"></span></th>
                        <th onclick="sortExpenses('amt')">é‡‘é¡ <span id="sort_e_amt"></span></th>
                        <th onclick="sortExpenses('bank')">éŠ€è¡Œ <span id="sort_e_bank"></span></th>
                        <th onclick="sortExpenses('status')">ç‹€æ…‹ <span id="sort_e_status"></span></th>
                        <th>æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody id="e_list"></tbody>
            </table>
        </div>
    </div>

    <div id="parties" class="tab-content">
        <div class="card">
            <h4>åå–®ç®¡ç†</h4>
            <form id="partyForm" onsubmit="event.preventDefault(); saveParty();">
                <input type="hidden" id="p_edit_id">
                <div class="form-grid">
                    <div class="form-group"><label>é¡å‹</label><select id="p_type"><option value="c">å®¢æˆ¶</option><option value="v">å» å•†</option></select></div>
                    <div class="form-group"><label>åç¨±</label><input type="text" id="p_name" placeholder="å…¬å¸/å€‹äººåç¨±" required></div>
                    <div class="form-group"><label>çµ±ç·¨</label><input type="text" id="p_tax" placeholder="çµ±ç·¨"></div>
                    <div class="form-group" style="grid-column: span 2;"><label>åœ°å€</label><input type="text" id="p_address" placeholder="åœ°å€"></div>
                    <div class="form-group" style="grid-column: span 2;"><label>å‚™è¨»</label><input type="text" id="p_note" placeholder="å‚™è¨» (ex: çµå¸³æ—¥/ç¿’æ…£)"></div>
                </div>
                <div style="margin-top:15px; padding:10px; background:#fff7ed; border:1px solid #ffedd5; border-radius:6px; display:flex; align-items:center;">
                    <input type="checkbox" id="p_is_prepaid" style="width:20px; height:20px; margin-right:10px;">
                    <div>
                        <label for="p_is_prepaid" style="font-size:14px; color:#c2410c; margin-bottom:2px; display:block;">è¨­å®šç‚ºé ä»˜å» å•† (è‡ªå‹•æ‰£æ¬¾)</label>
                        <span style="font-size:11px; color:#9a3412;">å‹¾é¸å¾Œï¼Œç™¼åŒ…çµ¦æ­¤å» å•†æ™‚ï¼Œä»˜æ¬¾æ–¹å¼å°‡é è¨­ç‚ºã€Œé ä»˜æ‰£æ¬¾ã€ï¼Œä¸¦è‡ªå‹•å¾é¤˜é¡æ‰£é™¤ã€‚</span>
                    </div>
                </div>

                <div style="margin-top:15px; background:#eff6ff; padding:15px; border-radius:8px; border:1px solid #bfdbfe;">
                    <label style="color:#1e3a8a; font-weight:bold;">ğŸ“ è¯çµ¡äºº / é›»è©± / Line (å¤šé¸)</label>
                    <div id="contact_area" style="margin-top:10px;"></div>
                    <button type="button" class="btn btn-outline btn-sm" onclick="addContactRow()">+ æ–°å¢è¯çµ¡äºº</button>
                </div>
                <div style="margin-top:20px;"><button class="btn btn-primary" style="width:100%">å„²å­˜åå–®</button></div>
            </form>
        </div>
        <div class="filter-bar">
            <h5>ğŸ” åå–®æœå°‹ (å«åœ°å€/å‚™è¨»/è¯çµ¡äºº)</h5>
            <div class="form-group" style="flex:1;">
                <input type="text" id="s_key_p" placeholder="æœå°‹é—œéµå­—..." oninput="renderParties()">
            </div>
        </div>
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:20px;">
            <div class="table-responsive"><h5 style="padding:10px;">ğŸ‘¤ å®¢æˆ¶åˆ—è¡¨</h5><table id="c_table"><thead><tr><th>åç¨± (æ»‘é¼ æ‡¸åœæŸ¥çœ‹è©³æƒ…)</th><th>æ“ä½œ</th></tr></thead><tbody></tbody></table></div>
            <div class="table-responsive"><h5 style="padding:10px;">ğŸ­ å» å•†åˆ—è¡¨</h5><table id="v_table"><thead><tr><th>åç¨± (æ»‘é¼ æ‡¸åœæŸ¥çœ‹è©³æƒ…)</th><th>æ“ä½œ</th></tr></thead><tbody></tbody></table></div>
        </div>
    </div>

    <div id="banks" class="tab-content">
        <div class="card">
            <h4>ğŸ¦ éŠ€è¡Œ / ğŸ’³ ä¿¡ç”¨å¡ / ğŸ’µ ç¾é‡‘</h4>
            <div style="float:right; display:flex; gap:5px; margin-bottom:10px;">
                <button class="btn btn-blue" onclick="openPrepaidModal()">ğŸ­ å» å•†é ä»˜ç®¡ç†</button>
                <button class="btn btn-success" onclick="openBankModal()">ğŸ’° å­˜ / æ / è½‰</button>
            </div>
            <div id="bank_total_summary" style="background:#dcfce7; padding:15px; border-radius:8px; margin-bottom:15px; border:1px solid #86efac; display:flex; flex-wrap:wrap; gap:20px; align-items:center;">
                <h3 style="margin:0; color:#166534;">ğŸ’° è³‡é‡‘ç¸½æ°´ä½: <span id="total_fund_display">$0</span></h3>
                <h3 style="margin:0; color:#c2410c; font-size:13px;">(å¦æœ‰å» å•†é ä»˜ç¸½é¡: <span id="total_prepaid_display">$0</span>)</h3>
            </div>
            <div class="form-grid" style="align-items:flex-end;">
                <div class="form-group"><label>é¡å‹</label><select id="b_type" onchange="toggleCardInputs()"><option value="bank">éŠ€è¡Œå­˜æ‘º</option><option value="credit">ä¿¡ç”¨å¡</option><option value="cash">ç¾é‡‘(é›¶ç”¨é‡‘)</option></select></div>
                <div class="form-group"><label>åç¨±</label><input type="text" id="b_name" placeholder="åç¨±"></div>
                <div class="form-group bank-only"><label>åˆå§‹é¤˜é¡</label><input type="number" id="b_bal" placeholder="0"></div>
                <div class="form-group card-only hidden"><label>çµå¸³æ—¥</label><input type="number" id="b_stmt" placeholder="27"></div>
                <div class="form-group card-only hidden"><label>å¯¬é™æœŸ</label><input type="number" id="b_gap" placeholder="15"></div>
                <button class="btn btn-primary" onclick="saveBank()">æ–°å¢</button>
            </div>
        </div>
        <div class="filter-bar">
            <h5>ğŸ” å­˜å–ç´€éŒ„ç¯©é¸</h5>
            <input type="date" id="fb_start" onchange="renderBanks()"><input type="date" id="fb_end" onchange="renderBanks()">
        </div>
        <div id="bank_card_list" class="dashboard-grid"></div>
    </div>
</div>

<script>
    // === ç´”é›²ç«¯ç‰ˆæ ¸å¿ƒè¨­å®š ===
    let API_URL = 'https://script.google.com/macros/s/AKfycbxe2sRP07xV2y-Hmon3Z6Mocue8F1OXcdD5x-TiRsTq4PCNBNQa-ILl2kGKRLF4uqlZUg/exec'; 

    window.onerror = function(msg, url, line) {
        document.getElementById('error_rescue').style.display = 'block';
        toggleLoading(false); 
        return false;
    };

    // åˆå§‹åŒ–ç©ºè³‡æ–™åº« (ä¸è®€å–æœ¬åœ°)
    let db = { o: [], e: [], b: [], r: [], p: [], invPool: [], products: [] };
    let Charts = { pie:null, line:null, bar:null, cust:null };
    let sortState = { field: 'date', dir: 'desc' };
    let sortStateR = { field: 'nextDate', dir: 'asc' };
    let sortStateE = { field: 'date', dir: 'desc' };
    const PREPAID_KEY = 'PREPAID'; 

    const DEFAULT_PRODUCTS = [
        "PPäº®","PPéœ§","PVCéœ§","PVCäº®","å…¨é€äº®","å…¨é€éœ§","åŠé€äº®","åŠé€éœ§","é›™é€å¸ƒ","å–®é€å¸ƒ",
        "æ²¹ç•«å¸ƒ","æ–œç´‹å¸ƒ","åˆæˆæ¿","å¼·å…‰æ¿","ç™¼æ³¡æ¿","ä¸­ç©ºæ¿","ç„¡æ¥ç¸«","å£“å…‹åŠ›",
        "ç«‹é«”ç™¼å…‰å­—","éœ“è™¹ç‡ˆå­—","æ‹›ç‰Œç‡ˆç®±","å£“å…‹åŠ›ç‡ˆç®±"
    ];

    // 1. å•Ÿå‹•é‚è¼¯ï¼šå¼·åˆ¶é›²ç«¯è®€å–
    window.onload = async function() {
        let storedUrl = localStorage.getItem('erp_api_url');
        if(storedUrl) API_URL = storedUrl;

        if (!API_URL || API_URL.includes('è«‹å°‡')) {
            alert("è«‹å…ˆè¨­å®š Google Script API ç¶²å€ï¼");
            openConfig();
            return;
        }

        document.getElementById('o_date').valueAsDate = new Date(); 
        document.getElementById('e_date').valueAsDate = new Date();

        await syncData();
    };

    // 2. é¡¯ç¤º/éš±è—é®ç½©
    function toggleLoading(show, text="è³‡æ–™è™•ç†ä¸­...") {
        const overlay = document.getElementById('cloudLoadingOverlay');
        const txt = document.getElementById('cloudLoadingText');
        if(show) {
            txt.innerText = text;
            overlay.style.display = 'flex';
        } else {
            overlay.style.display = 'none';
        }
    }

    // 3. åŒæ­¥è³‡æ–™ (è®€å–)
    async function syncData(force=false) {
        toggleLoading(true, "â˜ï¸ æ­£åœ¨ä¸‹è¼‰é›²ç«¯è³‡æ–™...");
        setStatus('sync', 'ä¸‹è¼‰ä¸­');
        
        try {
            const res = await fetch(API_URL);
            const data = await res.json();
            
            if(data) {
                if(!data.o) data.o = [];
                if(!data.e) data.e = [];
                if(!data.b) data.b = [{id:1, name:'ç¾é‡‘', type:'cash', bal:0, hist:[]}];
                if(!data.r) data.r = [];
                if(!data.p) data.p = [];
                if(!data.invPool) data.invPool = [];
                if(!data.products || !Array.isArray(data.products) || data.products.length === 0) data.products = [...DEFAULT_PRODUCTS];

                db = data;
                
                renderAll();
                updateInvPoolUI();
                renderProductOptions();
                
                setStatus('ok', 'å·²é€£ç·š');
                if(force) alert("âœ… åŒæ­¥å®Œæˆï¼");
            }
        } catch(e) {
            console.error(e);
            setStatus('err', 'é€£ç·šå¤±æ•—');
            alert("âŒ ç„¡æ³•é€£ç·šè‡³é›²ç«¯ï¼Œè«‹æª¢æŸ¥ç¶²è·¯ã€‚");
        } finally {
            toggleLoading(false);
        }
    }

    // 4. å„²å­˜è³‡æ–™ (å¯«å…¥) - å–ä»£åŸæœ¬çš„ save()
// ä¿®æ”¹å¾Œçš„ save å‡½å¼ (ç¬¬ 542-565 è¡Œ)
async function save() {
    toggleLoading(true, "ğŸ’¾ æ­£åœ¨å±€éƒ¨åŒæ­¥é›²ç«¯...");
    setStatus('sync', 'ä¸Šå‚³ä¸­');

    try {
        renderAll(); 
        updateInvPoolUI();

        // å°è£ ERP ç³»çµ±å°ˆå±¬è³‡æ–™ï¼Œä¸¦å¸¶ä¸Š action æ¨™ç±¤
        const payload = {
            action: 'save_erp',
            orders: db.o,
            expenses: db.e,
            banks: db.b,
            parties: db.p,
            recurring: db.r,
            invPool: db.invPool,
            products: db.products
        };

        await fetch(API_URL, {
            method: 'POST',
            mode: 'no-cors',
            headers: {'Content-Type':'application/json'},
            body: JSON.stringify(payload) // ä¿®æ”¹è™•ï¼šå‚³é€ payload è€Œä¸æ˜¯ db
        });

        setStatus('ok', 'å·²å„²å­˜');
    } catch(e) {
        console.error(e);
        setStatus('err', 'ä¸Šå‚³å¤±æ•—');
        alert("âŒ ä¸Šå‚³å¤±æ•—ï¼è«‹æª¢æŸ¥ç¶²è·¯ï¼Œè³‡æ–™å°šæœªå¯«å…¥é›²ç«¯ã€‚");
    } finally {
        toggleLoading(false);
    }
}
    // --- Helper Functions ---
    function showPartyPreview(name, type, e) {
        const p = db.p.find(x => x.name == name && (type ? x.type == type : true));
        if (!p) return;
        let contactsHtml = '';
        if(p.contacts && p.contacts.length > 0) {
            contactsHtml = p.contacts.map(c => 
                `<div class="preview-row"><span>${c.n || 'ç„¡å'}</span><span>${c.p || ''} ${c.l ? `<span style="color:#16a34a; font-size:10px;">(L:${c.l})</span>`:''}</span></div>`
            ).join('');
        } else if (p.contact || p.phone) {
            contactsHtml = `<div class="preview-row"><span>${p.contact || 'ç„¡å'}</span><span>${p.phone || ''}</span></div>`;
        }
        const tooltip = document.getElementById('party_preview_tooltip');
        let ppHtml = '';
        if(p.type === 'v' && p.prepaid && p.prepaid !== 0) {
            ppHtml = `<div style="margin-top:5px; padding:3px; background:#fff7ed; color:#c2410c; border:1px solid #ffedd5; font-weight:bold; text-align:center;">ğŸ’° é ä»˜é¤˜é¡: $${Number(p.prepaid).toLocaleString()}</div>`;
        }
        tooltip.innerHTML = `
            <div class="preview-title">
                ${p.type === 'c' ? 'ğŸ‘¤ å®¢æˆ¶è©³æƒ…' : 'ğŸ­ å» å•†è©³æƒ…'}
            </div>
            <div style="font-size:14px; font-weight:bold; margin-bottom:5px;">${p.name} ${p.isPrepaid?'<span class="prepaid-badge">é ä»˜</span>':''}</div>
            <div style="margin-bottom:8px; color:#64748b; font-size:12px;">çµ±ç·¨: ${p.tax || 'ç„¡'}</div>
            ${p.address ? `<div style="margin-bottom:2px;">ğŸ“ ${p.address}</div>` : ''}
            ${ppHtml}
            <div style="margin-top:8px; border-top:1px dashed #eee; padding-top:5px;">
                <b style="font-size:12px; color:#475569;">è¯çµ¡çª—å£:</b>
                ${contactsHtml || '<div style="color:#ccc;font-style:italic">ç„¡è¯çµ¡äººè³‡æ–™</div>'}
            </div>
            ${p.note ? `<div style="margin-top:8px; padding:5px; background:#f8fafc; border-radius:4px; border:1px solid #e2e8f0; font-size:12px; color:#555;">ğŸ“ ${p.note}</div>` : ''}
        `;
        let left = e.clientX + 15; let top = e.clientY + 15;
        if(left + 250 > window.innerWidth) left = e.clientX - 265;
        tooltip.style.left = left + 'px'; tooltip.style.top = top + 'px'; tooltip.style.display = 'block';
    }
    function hidePartyPreview() { document.getElementById('party_preview_tooltip').style.display = 'none'; }
    function safeNum(v) { if (v === null || v === undefined || v === '') return 0; let n = parseFloat(String(v).replace(/[^\d.-]/g,'')); return isNaN(n) ? 0 : n; }

    function setDateRange(type, prefix) {
        const now = new Date(); let start, end; const y = now.getFullYear(); const m = now.getMonth();
        if (type === 'month') { start = new Date(y, m, 1); end = new Date(y, m + 1, 0); } 
        else if (type === 'quarter') { const q = Math.floor(m / 3); start = new Date(y, q * 3, 1); end = new Date(y, (q + 1) * 3, 0); } 
        else if (type === 'year') { start = new Date(y, 0, 1); end = new Date(y, 11, 31); }
        const toISO = (d) => { const offset = d.getTimezoneOffset(); const local = new Date(d.getTime() - (offset*60*1000)); return local.toISOString().split('T')[0]; };
        document.getElementById(prefix + '_start').value = toISO(start); document.getElementById(prefix + '_end').value = toISO(end);
        if (prefix === 'fo') renderOrders(); else if (prefix === 'fr') renderRecurring(); else if (prefix === 'fe') renderExpenses();
    }
    function openConfig() { document.getElementById('configModal').style.display='flex'; document.getElementById('api_url_input').value = (API_URL.includes('è«‹å°‡') ? '' : API_URL); }
    function closeConfig() { document.getElementById('configModal').style.display='none'; }
    function setStatus(s,t) { document.querySelector('.dot').className='dot '+s; document.querySelector('.sync-status span').innerText=t; }
    function testConnection() { let u = document.getElementById('api_url_input').value.trim(); if(!u) return; fetch(u).then(r=>r.json()).then(d=>{ API_URL=u; localStorage.setItem('erp_api_url',u); closeConfig(); syncData(true); }).catch(e=>alert('é€£ç·šå¤±æ•—')); }
    
    // Legacy functions kept for logic
    function openPrepaidModal() {
        document.getElementById('prepaidModal').style.display = 'flex';
        renderPrepaidList();
        const vlist = document.getElementById('vlist_prepaid'); vlist.innerHTML = db.p.filter(p => p.type === 'v').map(p => `<option value="${p.name}">`).join('');
        document.getElementById('pp_source_bank').innerHTML = db.b.map(b => `<option value="${b.name}">${b.name}</option>`).join('');
    }
    function renderPrepaidList() {
        const div = document.getElementById('prepaid_list_div');
        const list = db.p.filter(p => p.type === 'v' && p.prepaid && p.prepaid !== 0).sort((a,b) => b.prepaid - a.prepaid);
        if(list.length === 0) { div.innerHTML = '<div style="text-align:center; padding:20px; color:#999;">ç›®å‰ç„¡ä»»ä½•é ä»˜é¤˜é¡</div>'; return; }
        div.innerHTML = list.map(p => `
            <div class="prepaid-row">
                <div>
                    <div style="font-weight:bold;">${p.name}</div>
                    <div style="font-size:12px; color:#666;">${p.tax || ''}</div>
                </div>
                <div class="prepaid-bal ${p.prepaid < 0 ? 'is-neg' : ''}" style="color:${p.prepaid>0?'#059669':'#ef4444'}">
                    $${Number(p.prepaid).toLocaleString()}
                </div>
            </div>
        `).join('');
    }
    function doPrepaidTopUp() {
        const vName = document.getElementById('pp_vendor').value.trim();
        const bName = document.getElementById('pp_source_bank').value;
        const amt = safeNum(document.getElementById('pp_amt').value);
        const note = document.getElementById('pp_note').value;
        if(!vName || amt <= 0) { alert("è«‹è¼¸å…¥å» å•†åç¨±åŠæœ‰æ•ˆé‡‘é¡"); return; }
        
        checkAndAddParty(vName, 'v');
        const p = db.p.find(x => x.name === vName && x.type === 'v');
        if(!p) { alert("å» å•†å»ºç«‹å¤±æ•—"); return; }
        if(typeof p.prepaid === 'undefined') p.prepaid = 0;
        if(!updateBank(bName, -amt, `[é ä»˜å„²å€¼] ${vName} - ${note}`)) { alert(`æ‰£æ¬¾å¤±æ•—ï¼æ‰¾ä¸åˆ°éŠ€è¡Œå¸³æˆ¶ [${bName}]`); return; }

        p.prepaid = Number(p.prepaid) + amt;
        alert(`å·²æˆåŠŸå„²å€¼ $${amt} çµ¦ ${vName}ï¼\nç›®å‰é¤˜é¡: $${p.prepaid}`);
        document.getElementById('pp_amt').value = ''; document.getElementById('pp_note').value = ''; renderPrepaidList(); save();
    }

    function openInvModal() { document.getElementById('invModal').style.display = 'flex'; updateInvPoolUI(); }
    function addInvoiceRange() {
        let prefix = document.getElementById('inv_prefix').value.trim().toUpperCase();
        let start = parseInt(document.getElementById('inv_start').value);
        let end = parseInt(document.getElementById('inv_end').value);
        if(!prefix || isNaN(start) || isNaN(end) || start > end) { alert('è«‹æª¢æŸ¥è¼¸å…¥è³‡æ–™æ ¼å¼ï¼'); return; }
        let count = 0; for(let i = start; i <= end; i++) { db.invPool.push(prefix + '-' + String(i).padStart(8, '0')); count++; }
        save(); updateInvPoolUI(); alert(`æˆåŠŸåŒ¯å…¥ ${count} çµ„ç™¼ç¥¨è™Ÿç¢¼ï¼`);
    }
    function clearInvoicePool() { if(confirm('ç¢ºå®šè¦æ¸…ç©ºæ‰€æœ‰æœªä½¿ç”¨çš„ç™¼ç¥¨è™Ÿç¢¼å—ï¼Ÿ')) { db.invPool = []; save(); updateInvPoolUI(); } }
    function updateInvPoolUI() {
        let count = db.invPool ? db.invPool.length : 0;
        let next = count > 0 ? db.invPool[0] : 'ç„¡';
        if(document.getElementById('inv_pool_count')) { document.getElementById('inv_pool_count').innerText = count; document.getElementById('inv_next_val').innerText = 'ä¸‹ä¸€å¼µ: ' + next; }
        let alertBox = document.getElementById('inv_alert_box'); if(alertBox) alertBox.style.display = (count < 5 && count > 0) ? 'block' : 'none';
    }

    function checkVendorPrepaidStatus(input) {
        const vName = input.value.trim();
        if(!vName) return;
        const p = db.p.find(x => x.name === vName && x.type === 'v');
        const container = input.parentElement;
        const bankSelect = container.querySelector('.sb');
        if (p && p.isPrepaid) {
            if(bankSelect.value !== PREPAID_KEY) {
                bankSelect.value = PREPAID_KEY;
                bankSelect.style.border = "2px solid #f97316"; 
                setTimeout(() => bankSelect.style.border = "1px solid #cbd5e1", 1000);
            }
        }
    }

    function calcTax(prefix, mode) {
        try {
            let idTotal = prefix === 'o' ? 'o_price' : 'e_amt';
            let idBase = prefix + '_base';
            let idTax = prefix + '_tax';
            let elTotal = document.getElementById(idTotal);
            let elBase = document.getElementById(idBase);
            let elTax = document.getElementById(idTax);

            if (!elTotal || !elBase || !elTax) return; 

            if (mode === 'total') {
                let total = safeNum(elTotal.value);
                let base = Math.round(total / 1.05);
                let tax = total - base;
                elBase.value = base;
                elTax.value = tax;
            } else {
                let base = safeNum(elBase.value);
                let total = Math.round(base * 1.05);
                let tax = total - base;
                elTotal.value = total;
                elTax.value = tax;
            }
        } catch (e) { console.error("Tax Calc Error", e); }
    }
    
    function updateBank(n, a, note){
        if(!n) return false;
        let cleanName = n.trim(); 
        let b = db.b.find(x => x.name === cleanName);
        if(b){
            b.bal += a;
            b.hist.unshift({date: new Date().toLocaleDateString(), amt: a, note: note});
            if(b.hist.length > 50) b.hist.pop();
            return true;
        }
        return false;
    }

    function renderReports() {
        if(!document.getElementById('reports').classList.contains('active')) return;
        try {
            if(Charts.pie) { Charts.pie.destroy(); Charts.pie = null; } 
            if(Charts.line) { Charts.line.destroy(); Charts.line = null; } 
            if(Charts.bar) { Charts.bar.destroy(); Charts.bar = null; } 
            if(Charts.cust) { Charts.cust.destroy(); Charts.cust = null; }
            if(typeof Chart === 'undefined') return;

            const ctxP = document.getElementById('c_pie');
            const ctxL = document.getElementById('c_line');
            const ctxB = document.getElementById('c_bar');
            const ctxC = document.getElementById('c_cust');
            
            if(!ctxP || !ctxL || !ctxB || !ctxC) return; 

            let c={æœª:0,è¨‚:0,å…¨:0}; 
            db.o.forEach(o => { 
                if(o.pay=='æœªæ”¶æ¬¾') c.æœª++; 
                else if(o.pay=='å·²æ”¶å…¨æ¬¾') c.å…¨++; 
                else c.è¨‚++; 
            });
            Charts.pie = new Chart(ctxP, {type:'doughnut', data:{labels:['æœªæ”¶æ¬¾','å·²æ”¶è¨‚é‡‘','å·²æ”¶å…¨æ¬¾'], datasets:[{data:[c.æœª, c.è¨‚, c.å…¨], backgroundColor:['#ef4444','#f59e0b','#10b981']}]}, options:{maintainAspectRatio: false}});

            let m={}, cust={}; 
            db.o.forEach(o=>{ 
                if(!o.date) return;
                let k=o.date.slice(0,7); 
                if(!m[k]) m[k]={i:0,o:0}; 
                m[k].i+= (safeNum(o.price) || 0); 
                
                if(o.cust) {
                    if(!cust[o.cust]) cust[o.cust]=0; 
                    cust[o.cust]+= (safeNum(o.price) || 0); 
                }
            }); 
            
            db.e.forEach(e=>{ 
                if(!e.date) return;
                let k=e.date.slice(0,7); 
                if(!m[k]) m[k]={i:0,o:0}; 
                m[k].o+= (safeNum(e.amt) || 0);
            });
            
            const ls=Object.keys(m).sort();
            
            Charts.line = new Chart(ctxL, {type:'line', data:{labels:ls, datasets:[{label:'ç‡Ÿæ”¶',data:ls.map(k=>m[k].i),borderColor:'#22c55e'},{label:'æ”¯å‡º',data:ls.map(k=>m[k].o),borderColor:'#ef4444'}]}, options:{maintainAspectRatio: false}});
            Charts.bar = new Chart(ctxB, {type:'bar', data:{labels:ls, datasets:[{label:'ç‡Ÿæ”¶',data:ls.map(k=>m[k].i),backgroundColor:'#10b981'},{label:'æ”¯å‡º',data:ls.map(k=>m[k].o),backgroundColor:'#ef4444'}]}, options:{maintainAspectRatio: false}});
            
            const sortedCust = Object.entries(cust).sort((a,b)=>b[1]-a[1]).slice(0,5);
            Charts.cust = new Chart(ctxC, {type:'bar', options:{indexAxis:'y', maintainAspectRatio: false}, data:{labels:sortedCust.map(x=>x[0]), datasets:[{label:'è²¢ç»é‡‘é¡',data:sortedCust.map(x=>x[1]),backgroundColor:'#3b82f6'}]}});

            let html = ''; 
            ls.forEach(k => { 
                let rev = m[k].i, exp = m[k].o, net = rev - exp; 
                let margin = rev>0 ? ((net/rev)*100).toFixed(1)+'%' : '0%'; 
                html += `<tr class="rpt-row"><td>${k}</td><td>$${rev.toLocaleString()}</td><td>$${exp.toLocaleString()}</td><td style="color:${net>=0?'green':'red'}">$${net.toLocaleString()}</td><td>${margin}</td></tr>`; 
            });
            const tBody = document.querySelector('#rpt_month_table tbody');
            if(tBody) tBody.innerHTML = html;
            
        } catch(e) { console.error("Report Render Error", e); }
    }

    function renderProductOptions() {
        const list = document.getElementById('productList');
        if(list && db.products) {
            list.innerHTML = db.products.map(p => `<option value="${p}">`).join('');
        }
    }

    function fillCustInfo(el) {
        const name = el.value.trim();
        if(!name) return;
        const p = db.p.find(x => x.name === name && x.type === 'c');
        
        if (p) {
            document.getElementById('o_addr').value = p.address || '';
            if (p.contacts && Array.isArray(p.contacts) && p.contacts.length > 0) {
                document.getElementById('o_contact').value = p.contacts.map(c => c.n).join(', ');
                document.getElementById('o_phone').value = p.contacts.map(c => c.p + (c.l ? '('+c.l+')' : '')).join(', ');
            } else {
                document.getElementById('o_contact').value = p.contact || '';
                document.getElementById('o_phone').value = p.phone || '';
            }
        }
    }

    function addItemRow(name='', spec='', w='', h='', t='', qty='', price='', total='') {
        const d = document.createElement('div'); d.className = 'item-grid';
        d.innerHTML = `
            <input class="i-name" placeholder="åç¨± (å¯é¸æˆ–è¼¸å…¥æ–°åç¨±)" value="${name}" list="productList">
            <input class="i-spec" placeholder="è¦æ ¼" value="${spec}">
            <input type="number" class="i-w" placeholder="å¯¬(cm)" value="${w}" oninput="calcItemTotal(this)" style="background:#f0f9ff;">
            <input type="number" class="i-h" placeholder="é«˜(cm)" value="${h}" oninput="calcItemTotal(this)" style="background:#f0f9ff;">
            <input type="number" class="i-t" placeholder="æ‰æ•¸" value="${t}" readonly style="background:#e0e7ff; color:#4338ca; font-weight:bold;">
            <input type="number" class="i-qty" placeholder="æ•¸é‡" value="${qty}" oninput="calcItemTotal(this)">
            <input type="number" class="i-price" placeholder="å–®åƒ¹" value="${price}" oninput="calcItemTotal(this)">
            <input type="number" class="i-total" placeholder="å°è¨ˆ" value="${total}" readonly style="background:#eee;">
            <button type="button" class="btn btn-danger btn-sm" onclick="this.parentElement.remove(); calcOrderSum();">X</button>
        `;
        document.getElementById('items_area').appendChild(d);
    }

    function calcItemTotal(el) {
        const row = el.parentElement;
        const w = safeNum(row.querySelector('.i-w').value);
        const h = safeNum(row.querySelector('.i-h').value);
        const qty = safeNum(row.querySelector('.i-qty').value);
        const price = safeNum(row.querySelector('.i-price').value);
        
        let talent = 0;
        if(w > 0 && h > 0) {
            talent = (w * h) / 900;
            talent = Math.round(talent * 10) / 10; 
            if(talent === 0 && w*h > 0) talent = 0.1;
        }
        row.querySelector('.i-t').value = talent > 0 ? talent : '';

        let total = 0;
        if(talent > 0) {
            total = talent * qty * price;
        } else {
            total = qty * price;
        }
        
        row.querySelector('.i-total').value = Math.round(total);
        calcOrderSum();
    }

    function calcOrderSum() {
        let sum = 0;
        document.querySelectorAll('.i-total').forEach(el => sum += safeNum(el.value));
        if(sum > 0) {
            document.getElementById('o_price').value = sum;
            calcTax('o', 'total');
        }
    }

    function saveOrder() {
        try {
            if (!confirm('ç¢ºå®šè¦å„²å­˜è¨‚å–®å—ï¼Ÿ')) return;
            const id = document.getElementById('o_edit_id').value;
            let invNum = document.getElementById('o_inv_num').value.trim();
            let invoiceType = document.getElementById('o_invoice').value;
            if ((!invNum && (invoiceType === 'äºŒè¯' || invoiceType === 'ä¸‰è¯'))) {
                if (db.invPool && db.invPool.length > 0) invNum = db.invPool.shift(); 
                else if(!id) alert('âš ï¸ ç™¼ç¥¨è™Ÿç¢¼åº«å­˜å·²ç”¨ç›¡ï¼');
            }

            const items = [];
            let newProductAdded = false;
            document.querySelectorAll('#items_area .item-grid').forEach(row => {
                let iName = row.querySelector('.i-name').value.trim();
                if(iName && !db.products.includes(iName)) {
                    db.products.push(iName);
                    newProductAdded = true;
                }
                items.push({
                    name: iName,
                    spec: row.querySelector('.i-spec').value,
                    w: safeNum(row.querySelector('.i-w').value),
                    h: safeNum(row.querySelector('.i-h').value),
                    t: safeNum(row.querySelector('.i-t').value),
                    qty: safeNum(row.querySelector('.i-qty').value),
                    price: safeNum(row.querySelector('.i-price').value),
                    total: safeNum(row.querySelector('.i-total').value)
                });
            });

            if(newProductAdded) { renderProductOptions(); }

            const o = {
                id: id ? Number(id) : Date.now(),
                date: document.getElementById('o_date').value,
                proj: document.getElementById('o_proj').value,
                cust: document.getElementById('o_cust').value,
                contact: document.getElementById('o_contact').value,
                phone: document.getElementById('o_phone').value,
                addr: document.getElementById('o_addr').value,
                invoice: invoiceType, invNum: invNum, 
                price: safeNum(document.getElementById('o_price').value),
                base: safeNum(document.getElementById('o_base').value), tax: safeNum(document.getElementById('o_tax').value),
                deposit: safeNum(document.getElementById('o_deposit').value),
                inv: document.getElementById('o_inv').value, pay: document.getElementById('o_pay').value, bank: document.getElementById('o_bank').value,
                note: document.getElementById('o_note').value, 
                subs: [],
                items: items 
            };
            checkAndAddParty(o.cust,'c');
            document.querySelectorAll('#sub_area .sub-grid').forEach(el=>{
                let sub = { 
                    v: el.querySelector('.sv').value, 
                    c: safeNum(el.querySelector('.sc').value, 0), 
                    s: el.querySelector('.ss').value, 
                    b: el.querySelector('.sb').value,
                    n: el.querySelector('.sn').value 
                };
                o.subs.push(sub); checkAndAddParty(sub.v, 'v');
            });

            if(!id){ 
                if(o.pay=='å·²æ”¶å…¨æ¬¾') updateBank(o.bank,o.price,'[å…¨é¡] '+o.proj);
                else if(o.pay=='å·²æ”¶è¨‚é‡‘') updateBank(o.bank,o.deposit,'[è¨‚é‡‘] '+o.proj);
                o.subs.forEach(sub => { 
                    if(sub.s == 'å·²æ”¯ä»˜') {
                        if(sub.b === PREPAID_KEY) {
                            let p = db.p.find(x => x.name === sub.v && x.type === 'v');
                            if(p) { if(typeof p.prepaid==='undefined') p.prepaid=0; p.prepaid = Number(p.prepaid) - sub.c; }
                        } else { updateBank(sub.b, -sub.c, '[åŒ…] ' + sub.v + ' - ' + o.proj); }
                    }
                });
                db.o.unshift(o);
            } else { 
                let old = db.o.find(x => x.id == Number(id));
                if(old) {
                    if (old.invNum && (invoiceType === 'ç„¡' || !invNum)) { if (!db.invPool.includes(old.invNum)) { db.invPool.unshift(old.invNum); db.invPool.sort(); alert(`ç™¼ç¥¨è™Ÿç¢¼ ${old.invNum} å·²å›æ”¶è‡³åº«å­˜ï¼`); } }
                    
                    if (old.pay === 'å·²æ”¶å…¨æ¬¾' && o.pay === 'æœªæ”¶æ¬¾') updateBank(o.bank, -old.price, `[åæ‚”é€€] ${o.proj} (å…¨é¡)`);
                    else if (old.pay === 'å·²æ”¶å…¨æ¬¾' && o.pay === 'å·²æ”¶è¨‚é‡‘') updateBank(o.bank, -(old.price - o.deposit), `[åæ‚”é€€] ${o.proj} (å°¾æ¬¾)`);
                    else if (old.pay === 'å·²æ”¶è¨‚é‡‘' && o.pay === 'æœªæ”¶æ¬¾') updateBank(o.bank, -old.deposit, `[åæ‚”é€€] ${o.proj} (è¨‚é‡‘)`);
                    else if (o.pay == 'å·²æ”¶å…¨æ¬¾' && old.pay != 'å·²æ”¶å…¨æ¬¾') {
                        if (old.pay == 'å·²æ”¶è¨‚é‡‘') { let bal = o.price - o.deposit; if(bal > 0) updateBank(o.bank, bal, '[å°¾æ¬¾] '+o.proj); } 
                        else updateBank(o.bank, o.price, '[å…¨é¡] '+o.proj); 
                    } else if (o.pay == 'å·²æ”¶è¨‚é‡‘' && old.pay == 'æœªæ”¶æ¬¾') updateBank(o.bank, o.deposit, '[è¨‚é‡‘] '+o.proj); 

                    old.subs.forEach((os, idx) => {
                        let ns = o.subs[idx];
                        if(!ns) return;
                        if (os.s === 'å·²æ”¯ä»˜' && ns.s !== 'å·²æ”¯ä»˜') {
                            if (os.b === PREPAID_KEY) {
                                let p = db.p.find(x => x.name === os.v && x.type === 'v');
                                if(p) p.prepaid = Number(p.prepaid || 0) + os.c; 
                            } else { updateBank(os.b, os.c, `[ä¿®æ­£é€€] ${os.v} - ${o.proj}`); }
                        }
                        else if (os.s !== 'å·²æ”¯ä»˜' && ns.s === 'å·²æ”¯ä»˜') {
                            if (ns.b === PREPAID_KEY) {
                                let p = db.p.find(x => x.name === ns.v && x.type === 'v');
                                if(p) p.prepaid = Number(p.prepaid || 0) - ns.c;
                            } else { updateBank(ns.b, -ns.c, `[åŒ…] ${ns.v} - ${o.proj}`); }
                        }
                        else if (os.s === 'å·²æ”¯ä»˜' && ns.s === 'å·²æ”¯ä»˜' && os.c !== ns.c) {
                             let diff = os.c - ns.c;
                             if (ns.b === PREPAID_KEY) {
                                 let p = db.p.find(x => x.name === ns.v && x.type === 'v');
                                 if(p) p.prepaid = Number(p.prepaid || 0) + diff;
                             } else { updateBank(ns.b, diff, `[ä¿®æ­£] ${ns.v} - ${o.proj}`); }
                        }
                    });
                    
                    for(let i=old.subs.length; i<o.subs.length; i++) {
                        let ns = o.subs[i];
                        if (ns.s === 'å·²æ”¯ä»˜') {
                            if (ns.b === PREPAID_KEY) {
                                let p = db.p.find(x => x.name === ns.v && x.type === 'v');
                                if(p) p.prepaid = Number(p.prepaid || 0) - ns.c;
                            } else { updateBank(ns.b, -ns.c, `[åŒ…] ${ns.v} - ${o.proj}`); }
                        }
                    }
                }
                db.o[db.o.findIndex(x=>x.id==Number(id))]=o; 
            }
            document.getElementById('orderForm').reset(); document.getElementById('sub_area').innerHTML=''; document.getElementById('items_area').innerHTML=''; document.getElementById('o_edit_id').value=''; save(); updateInvPoolUI(); 
        } catch(err) { console.error(err); alert("å„²å­˜æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹æª¢æŸ¥è³‡æ–™"); toggleLoading(false); }
    }

    function copyO(id) {
        const o = db.o.find(x => x.id == id);
        if(!o) return;

        document.getElementById('o_edit_id').value = ''; 
        document.getElementById('o_date').valueAsDate = new Date();
        document.getElementById('o_proj').value = o.proj + " (å‰¯æœ¬)";
        document.getElementById('o_cust').value = o.cust;
        document.getElementById('o_contact').value = o.contact || '';
        document.getElementById('o_phone').value = o.phone || '';
        document.getElementById('o_addr').value = o.addr || '';
        document.getElementById('o_invoice').value = o.invoice;
        document.getElementById('o_inv_num').value = ''; 
        
        document.getElementById('o_price').value = o.price;
        document.getElementById('o_base').value = o.base;
        document.getElementById('o_tax').value = o.tax;
        
        document.getElementById('o_deposit').value = 0; 
        document.getElementById('o_inv').value = 'æœªè«‹æ¬¾';
        document.getElementById('o_pay').value = 'æœªæ”¶æ¬¾';
        document.getElementById('o_bank').value = o.bank; 
        document.getElementById('o_note').value = o.note;

        document.getElementById('items_area').innerHTML = '';
        if(o.items && Array.isArray(o.items)){
            o.items.forEach(i => addItemRow(i.name, i.spec, i.w, i.h, i.t, i.qty, i.price, i.total));
        }

        document.getElementById('sub_area').innerHTML = '';
        if(o.subs && Array.isArray(o.subs)){
            o.subs.forEach(s => {
                addSubRow(s.v, s.c, 'æœªæ”¯ä»˜', s.b, s.n);
            });
        }

        switchTab('orders');
        document.getElementById('orderForm').scrollIntoView({ behavior: 'smooth' });
        alert("å·²è¤‡è£½è¨‚å–®è³‡æ–™ï¼\nç‹€æ…‹å·²é‡ç½®ç‚ºã€Œæœªæ”¶æ¬¾/æœªæ”¯ä»˜ã€ã€‚\nè«‹ç¢ºèªå…§å®¹å¾ŒæŒ‰ä¸‹å„²å­˜ã€‚");
    }

    function sortOrders(field) {
        if (sortState.field === field) sortState.dir = sortState.dir === 'asc' ? 'desc' : 'asc';
        else { sortState.field = field; sortState.dir = 'desc'; }
        document.querySelectorAll('th span').forEach(s => s.innerText = '');
        document.getElementById('sort_' + field).innerText = sortState.dir === 'asc' ? 'â–²' : 'â–¼';
        renderOrders();
    }
    
    function sortRecurring(field) {
        if (sortStateR.field === field) sortStateR.dir = sortStateR.dir === 'asc' ? 'desc' : 'asc';
        else { sortStateR.field = field; sortStateR.dir = 'asc'; }
        document.querySelectorAll('#recurring th span').forEach(s => s.innerText = '');
        document.getElementById('sort_r_' + field).innerText = sortStateR.dir === 'asc' ? 'â–²' : 'â–¼';
        renderRecurring();
    }

    function sortExpenses(field) {
        if (sortStateE.field === field) sortStateE.dir = sortStateE.dir === 'asc' ? 'desc' : 'asc';
        else { sortStateE.field = field; sortStateE.dir = 'desc'; }
        document.querySelectorAll('#expenses th span').forEach(s => s.innerText = '');
        document.getElementById('sort_e_' + field).innerText = sortStateE.dir === 'asc' ? 'â–²' : 'â–¼';
        renderExpenses();
    }

    function renderOrders() {
    const k = document.getElementById('s_key_o').value.toLowerCase();
    const pay = document.getElementById('fo_pay').value;
    const inv = document.getElementById('fo_inv').value;     // é€™æ˜¯åŸæœ‰çš„ã€Œè«‹æ¬¾ç‹€æ…‹ã€
    const subSt = document.getElementById('fo_sub_status').value;
    
    // [æ–°å¢] è®€å–é–‹ç¥¨ç‹€æ…‹
    const invSt = document.getElementById('fo_inv_status').value;

    const list = db.o.filter(o => {
        let subNames = o.subs.map(s => s.v).join(' ');
        let itemNames = (o.items || []).map(i => i.name).join(' ');
        let searchTarget = (
            o.proj + o.cust + (o.invNum || '') + (o.note || '') + 
            (o.contact||'') + (o.phone||'') + (o.addr||'') +
            o.price + o.deposit + subNames + itemNames
        ).toLowerCase();
        
        let m = searchTarget.includes(k);
        
        // åŸæœ‰çš„ç¯©é¸
        if(inv && o.inv!=inv) m=false;
        if(pay=='æœªæ”¶æ¬¾') { if(o.pay=='å·²æ”¶å…¨æ¬¾') m=false; } 
        else if(pay=='å·²æ”¶æ¬¾') { if(o.pay!='å·²æ”¶å…¨æ¬¾') m=false; }
        
        // [æ–°å¢] ç™¼ç¥¨è™Ÿç¢¼ç¯©é¸é‚è¼¯
        if (invSt === 'å·²é–‹') {
            if (!o.invNum || o.invNum.trim() === '') m = false;
        } else if (invSt === 'æœªé–‹') {
            if (o.invNum && o.invNum.trim() !== '') m = false;
        }
        
        // å» å•†æ¬¾ç¯©é¸
        if(subSt === 'æœªæ”¯ä»˜') {
            if(!o.subs || o.subs.length === 0 || o.subs.every(s => s.s === 'å·²æ”¯ä»˜')) m=false;
        } else if (subSt === 'å·²æ”¯ä»˜') {
            if(o.subs && o.subs.some(s => s.s !== 'å·²æ”¯ä»˜')) m=false;
        }

        // æ—¥æœŸç¯©é¸
        const s = document.getElementById('fo_start').value; 
        const e = document.getElementById('fo_end').value;
        if (s && o.date < s) m=false; 
        if (e && o.date > e) m=false;
        return m;
    });
    
    let totalAmt = 0; let totalProfit = 0;
    list.forEach(o => { let cost = o.subs.reduce((acc, s) => acc + s.c, 0); totalAmt += o.price; totalProfit += (o.price - cost); });
    document.getElementById('order_search_summary').innerHTML = `ğŸ“Š æœå°‹å°è¨ˆ (å…± ${list.length} ç­†): <span style="color:#2563eb">ç¸½é¡ $${totalAmt.toLocaleString()}</span> | <span style="color:#16a34a">åˆ©æ½¤ $${totalProfit.toLocaleString()}</span>`;

    list.sort((a, b) => {
        let valA = a[sortState.field]; let valB = b[sortState.field];
        if(sortState.field === 'price') return sortState.dir === 'asc' ? valA - valB : valB - valA;
        if (valA < valB) return sortState.dir === 'asc' ? -1 : 1;
        if (valA > valB) return sortState.dir === 'asc' ? 1 : -1;
        return 0;
    });

    document.getElementById('o_list').innerHTML = list.map(o => {
        let status = `<span class="badge ${o.pay=='å·²æ”¶å…¨æ¬¾'?'b-green':(o.pay=='å·²æ”¶è¨‚é‡‘'?'b-blue':'b-red')}">${o.pay}</span>`;
        if(o.pay=='å·²æ”¶è¨‚é‡‘') { let bal=o.price-o.deposit; status+=`<br><small style="color:#d97706;font-weight:bold;">(è¨‚:$${o.deposit.toLocaleString()} / å°¾:$${bal.toLocaleString()})</small>`; }
        
        let totalSub = o.subs.reduce((sum, sub) => sum + sub.c, 0);
        let profit = o.price - totalSub;
        
        let subs = o.subs.map(s=>{
            let bankDisplay = s.b === PREPAID_KEY ? '<b style="color:#c2410c">ğŸ”´é ä»˜</b>' : s.b;
            return `<div class="sub-item"><span class="${s.s=='å·²æ”¯ä»˜'?'b-green':'b-red'}">â—</span> ${s.v} $${s.c.toLocaleString()} <span style="color:#94a3b8;font-size:10px;">(${bankDisplay})</span>${s.n?`<br><span style="color:#666;font-size:10px;">ğŸ“${s.n}</span>`:''}</div>`;
        }).join('');
        
        let itemsSummary = '';
        if(o.items && o.items.length > 0) {
            let firstTwo = o.items.slice(0, 2).map(i => i.name).join(', ');
            let more = o.items.length > 2 ? `... (+${o.items.length - 2})` : '';
            itemsSummary = `<div style="font-size:11px; color:#64748b; margin-top:2px;">ğŸ“¦ ${firstTwo}${more}</div>`;
        }

        return `<tr><td>${o.date}</td><td><b>${o.proj}</b>${itemsSummary}<br><small class="hover-info" onmouseenter="showPartyPreview('${o.cust}','c',event)" onmouseleave="hidePartyPreview()">${o.cust}</small></td><td style="color:#4f46e5; font-weight:bold;">${o.invNum || '-'}</td><td>ç¸½:$${o.price.toLocaleString()}<br><small style="color:${profit>=0?'#10b981':'#ef4444'}">åˆ©:$${profit.toLocaleString()}</small></td><td>${status}</td><td>${subs||'-'}</td><td><button class="btn btn-sm btn-primary" onclick="editO(${o.id})">ç·¨</button> <button class="btn btn-sm btn-success" onclick="copyO(${o.id})" title="è¤‡è£½æ­¤è¨‚å–®">ğŸ“„</button> <button class="btn btn-sm btn-danger" onclick="del('o',${o.id})">åˆª</button></td></tr>`;
    }).join('');
}

    function saveRecurring(){
        if (!confirm('ç¢ºå®šè¦å„²å­˜å›ºå®šæ”¯å‡ºå—ï¼Ÿ')) return;
        const id=document.getElementById('r_edit_id').value,cy=Number(document.getElementById('r_cycle_val').value),r={id:id?Number(id):Date.now(),title:document.getElementById('r_title').value,amt:safeNum(document.getElementById('r_amt').value),period:document.getElementById('r_period').value,cycleVal:cy,start:document.getElementById('r_start').value,end:document.getElementById('r_end').value,bank:document.getElementById('r_bank').value,note:document.getElementById('r_note').value,nextDate:calcNext(document.getElementById('r_start').value,document.getElementById('r_period').value,cy)};if(id)db.r[db.r.findIndex(x=>x.id==id)]=r;else db.r.push(r);document.getElementById('recurForm').reset();document.getElementById('r_edit_id').value='';save();
    }
    function payRecur(id,d){const r=db.r.find(x=>x.id==id);if(!confirm(`æ”¯ä»˜ ${r.title}?`))return;updateBank(r.bank,-r.amt,'[å›º] '+r.title);db.e.unshift({id:Date.now(),date:d,note:`(å›º)${r.title}`,target:'-',amt:r.amt,base:Math.round(r.amt/1.05),tax:r.amt-Math.round(r.amt/1.05),bank:r.bank,status:'å·²æ”¯ä»˜',remark:r.note,linkId:r.id});r.nextDate=calcNext(r.nextDate,r.period,r.cycleVal);save();}
    
    function renderRecurring(){
        const k=document.getElementById('s_key_r').value.toLowerCase();
        const s=document.getElementById('fr_start').value, e=document.getElementById('fr_end').value;
        let list = db.r.filter(r => { let m = r.title.toLowerCase().includes(k); if(s && r.nextDate < s) m=false; if(e && r.nextDate > e) m=false; return m; });
        
        list.sort((a,b) => {
            let valA = a[sortStateR.field], valB = b[sortStateR.field];
            if(valA < valB) return sortStateR.dir === 'asc' ? -1 : 1;
            if(valA > valB) return sortStateR.dir === 'asc' ? 1 : -1;
            return 0;
        });

        const today = new Date();
        today.setHours(0,0,0,0);
        
        const notifyCenter = document.getElementById('notify_center');
        const badge = document.getElementById('recur_badge');
        let notifyHtml = '';
        let notifyCount = 0;

        list.forEach(r => {
            let nextD = new Date(r.nextDate);
            nextD.setHours(0,0,0,0);
            let diffTime = nextD - today;
            let diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

            if(diffDays < 0) { 
                notifyCount++;
                notifyHtml += `
                    <div class="notify-card overdue">
                        <div class="notify-icon">ğŸš¨</div>
                        <div class="notify-content">
                            <h4>${r.title} å·²é€¾æœŸï¼</h4>
                            <ul>
                                <li>æ‡‰ä»˜é‡‘é¡: $${r.amt.toLocaleString()}</li>
                                <li>åˆ°æœŸæ—¥: ${r.nextDate} (é€¾æœŸ ${Math.abs(diffDays)} å¤©)</li>
                                <li>æ‰£æ¬¾å¸³æˆ¶: ${r.bank}</li>
                            </ul>
                        </div>
                        <div class="notify-action">
                            <button class="btn btn-sm btn-danger" onclick="payRecur(${r.id},'${r.nextDate}')">ç«‹å³æ”¯ä»˜</button>
                        </div>
                    </div>`;
            } else if(diffDays <= 3) {
                notifyCount++;
                notifyHtml += `
                    <div class="notify-card soon">
                        <div class="notify-icon">â°</div>
                        <div class="notify-content">
                            <h4>${r.title} å³å°‡åˆ°æœŸ</h4>
                            <ul>
                                <li>æ‡‰ä»˜é‡‘é¡: $${r.amt.toLocaleString()}</li>
                                <li>åˆ°æœŸæ—¥: ${r.nextDate} (å‰© ${diffDays} å¤©)</li>
                            </ul>
                        </div>
                    </div>`;
            }
        });

        if(notifyCount > 0) {
            notifyCenter.innerHTML = `<h3 style="margin-top:0; color:#334155; font-size:16px;">ğŸ”” å¾…è¾¦äº‹é …ä¸­å¿ƒ (${notifyCount})</h3>` + notifyHtml;
            notifyCenter.style.display = 'block';
            badge.innerText = notifyCount > 9 ? '9+' : notifyCount;
            badge.style.display = 'block';
        } else {
            notifyCenter.style.display = 'none';
            badge.style.display = 'none';
        }

        document.getElementById('r_list').innerHTML=list.map(r=>{
            let ds=getNext5(r.nextDate,r.period,r.cycleVal,r.end); 
            let rowStyle = '';
            let statusBadge = '';
            let nextD = new Date(r.nextDate); nextD.setHours(0,0,0,0);
            let diff = Math.ceil((nextD - today) / (1000 * 60 * 60 * 24));
            
            if(diff < 0) { rowStyle='background:#fee2e2'; statusBadge='<span style="color:red;font-weight:bold;font-size:11px;">âš ï¸ é€¾æœŸ</span>'; }
            else if(diff <= 3) { rowStyle='background:#fff7ed'; statusBadge='<span style="color:#d97706;font-weight:bold;font-size:11px;">â³ è¿‘æœŸ</span>'; }

            return `<tr style="${rowStyle}">
                <td><b>${r.title}</b> ${statusBadge}<br><small style='color:#666'>${r.note||''}</small></td>
                <td>${r.bank}</td>
                <td>$${r.amt.toLocaleString()}</td>
                <td>${ds.map(d=>`<button class="btn btn-outline btn-sm" onclick="payRecur(${r.id},'${d}')">${d}</button>`).join(' ')}</td>
                <td><button class="btn btn-sm btn-primary" onclick="editR(${r.id})">ç·¨</button><button class="btn btn-sm btn-danger" onclick="del('r',${r.id})">åˆª</button></td>
            </tr>`
        }).join('');
    }

    function saveExpense() {
        if (!confirm('ç¢ºå®šè¦å„²å­˜æ”¯å‡ºå—ï¼Ÿ')) return;
        const id = document.getElementById('e_edit_id').value; const bn = document.getElementById('e_bank').value; const amt = safeNum(document.getElementById('e_amt').value);
        const e = { id: id ? Number(id) : Date.now(), date: document.getElementById('e_date').value, note: document.getElementById('e_note').value, target: document.getElementById('e_target').value, amt: amt, base: safeNum(document.getElementById('e_base').value), tax: safeNum(document.getElementById('e_tax').value), bank: bn, status: document.getElementById('e_status').value, remark: document.getElementById('e_remark').value };
        if(!id) { if(e.status === 'å·²æ”¯ä»˜') updateBank(bn, -amt, `[æ”¯] ${e.note}`); db.e.unshift(e); } 
        else {
            let old = db.e.find(x => x.id == Number(id));
            if(old) {
                if (old.status === 'å·²æ”¯ä»˜' && e.status === 'æœªæ”¯ä»˜') updateBank(old.bank, old.amt, `[åæ‚”é€€] ${old.note}`);
                else if (old.status !== 'å·²æ”¯ä»˜' && e.status === 'å·²æ”¯ä»˜') updateBank(e.bank, -e.amt, `[æ”¯] ${e.note}`);
                else if (old.status === 'å·²æ”¯ä»˜' && e.status === 'å·²æ”¯ä»˜') { if (old.bank !== e.bank) { updateBank(old.bank, old.amt, `[è½‰å‡º] ${old.note} (æ›è¡Œ)`); updateBank(e.bank, -e.amt, `[è½‰å…¥] ${e.note} (æ›è¡Œ)`); } else if (old.amt !== e.amt) { let diff = old.amt - e.amt; updateBank(e.bank, diff, `[ä¿®æ­£] ${e.note}`); } }
            }
            db.e[db.e.findIndex(x=>x.id==Number(id))] = e;
        }
        document.getElementById('expForm').reset(); document.getElementById('e_edit_id').value=''; save();
    }
    
    function renderExpenses(){
        const k=document.getElementById('s_key_e').value.toLowerCase(), st=document.getElementById('fe_status').value; const s=document.getElementById('fe_start').value, e=document.getElementById('fe_end').value;
        let list = db.e.filter(e => { let m = (e.note+e.target).toLowerCase().includes(k); if(st && e.status != st) m=false; if(s && e.date < s) m=false; if(e && e.date > e) m=false; return m; });
        
        list.sort((a,b) => {
            let valA = a[sortStateE.field], valB = b[sortStateE.field];
            if(valA < valB) return sortStateE.dir === 'asc' ? -1 : 1;
            if(valA > valB) return sortStateE.dir === 'asc' ? 1 : -1;
            return 0;
        });

        document.getElementById('e_list').innerHTML=list.map(e=>`<tr><td>${e.date}</td><td>${e.note}<br><small style='color:#666'>${e.remark||''}</small></td><td class="hover-info" onmouseenter="showPartyPreview('${e.target}','v',event)" onmouseleave="hidePartyPreview()">${e.target||''}</td><td>$${e.amt.toLocaleString()}</td><td>${e.bank}</td><td><span class="badge ${e.status=='å·²æ”¯ä»˜'?'b-green':'b-red'}">${e.status}</span></td><td><button class="btn btn-sm btn-primary" onclick="editE(${e.id})">ç·¨</button><button class="btn btn-sm btn-danger" onclick="del('e',${e.id})">åˆª</button></td></tr>`).join('');
    }

    function saveBank() { const n=document.getElementById('b_name').value, t=document.getElementById('b_type').value; if(!n) return; const b = {id:Date.now(), name:n, type:t, bal:safeNum(document.getElementById('b_bal').value), stmtDay:27, payGap:15, hist:[]}; db.b.push(b); document.getElementById('b_name').value=''; save(); }
    function renderBanks() {
        const s = document.getElementById('fb_start').value, e = document.getElementById('fb_end').value;
        let total = db.b.reduce((acc, b) => acc + safeNum(b.bal), 0);
        let totalPrepaid = db.p.reduce((acc, p) => acc + (p.prepaid || 0), 0);
        let totalEl = document.getElementById('total_fund_display'); if(totalEl) { totalEl.innerText = '$' + total.toLocaleString(); totalEl.style.color = total >= 0 ? '#166534' : '#ef4444'; }
        let totalPPEl = document.getElementById('total_prepaid_display'); if(totalPPEl) { totalPPEl.innerText = '$' + totalPrepaid.toLocaleString(); totalPPEl.style.color = totalPrepaid >= 0 ? '#166534' : '#ef4444'; }
        document.getElementById('bank_card_list').innerHTML = db.b.map(b => {
            let hist = b.hist.filter(h => (!s||h.date>=s)&&(!e||h.date<=e));
            let colorClass = b.type=='credit' ? 'bg-g-red' : (b.type=='cash' ? 'bg-g-orange' : 'bg-g-green');
            return `<div class="kpi-card ${colorClass}"><h3>${b.name}</h3><div class="val">${b.type=='credit'?'å¡':(b.type=='cash'?'ç¾':'éŠ€')}:$${b.bal.toLocaleString()}</div><div class="bank-history">${hist.map(h=>`<div class="bank-item"><span>${h.date} ${h.note}</span><span>$${h.amt}</span></div>`).join('')}</div><button class="btn btn-sm btn-danger" style="margin-top:5px" onclick="del('b',${b.id})">åˆªé™¤</button></div>`;
        }).join('');
    }
    
    function openBankModal(){ document.getElementById('bankModal').style.display='flex'; document.getElementById('bt_date').valueAsDate=new Date(); updateBankSelects(); toggleBankTransFields(); }
    function closeBankModal(){ document.getElementById('bankModal').style.display='none'; }
    function toggleBankTransFields(){ const t = document.getElementById('bt_type').value; document.getElementById('div_target').classList.toggle('hidden', t !== 'transfer'); document.getElementById('lbl_source').innerText = (t==='deposit' ? 'å­˜å…¥å¸³æˆ¶' : (t==='withdraw' ? 'ææ¬¾å¸³æˆ¶' : 'è½‰å‡ºå¸³æˆ¶')); }
    function saveBankTrans(){
        const t = document.getElementById('bt_type').value; const src = document.getElementById('bt_source').value; const tgt = document.getElementById('bt_target').value; const amt = safeNum(document.getElementById('bt_amt').value); const note = document.getElementById('bt_note').value;
        if(amt <= 0){ alert('é‡‘é¡å¿…é ˆå¤§æ–¼ 0'); return; } 
        if(!src){ alert('è«‹é¸æ“‡å¸³æˆ¶'); return; } 
        if(t==='transfer' && src===tgt){ alert('è½‰å‡ºèˆ‡è½‰å…¥å¸³æˆ¶ä¸èƒ½ç›¸åŒ'); return; }
        
        if(t === 'deposit') { if(!updateBank(src, amt, `[å­˜] ${note}`)) return alert("å­˜å…¥å¤±æ•—: æ‰¾ä¸åˆ°å¸³æˆ¶"); } 
        else if(t === 'withdraw') { if(!updateBank(src, -amt, `[æ] ${note}`)) return alert("ææ¬¾å¤±æ•—: æ‰¾ä¸åˆ°å¸³æˆ¶"); } 
        else if(t === 'transfer'){ if(!updateBank(src, -amt, `[è½‰å‡º->${tgt}] ${note}`)) return alert("è½‰å‡ºå¤±æ•—: æ‰¾ä¸åˆ°è½‰å‡ºå¸³æˆ¶"); if(!updateBank(tgt, amt, `[è½‰å…¥<-${src}] ${note}`)) return alert("è½‰å…¥å¤±æ•—: æ‰¾ä¸åˆ°è½‰å…¥å¸³æˆ¶"); }
        save(); alert('äº¤æ˜“å·²è¨˜éŒ„'); closeBankModal(); document.getElementById('bt_amt').value=''; document.getElementById('bt_note').value='';
    }

    function updateBankSelects(){
        const h=db.b.map(b=>`<option value="${b.name}">${b.name}</option>`).join('');
        document.querySelectorAll('.bank-sel').forEach(s=>{ if(s.id !== 'bt_target' && s.id !== 'bt_source' && s.id !== 'pp_source_bank') s.innerHTML=h; }); 
        const ms = document.getElementById('bt_source'); if(ms) ms.innerHTML = h; 
        const mt = document.getElementById('bt_target'); if(mt) mt.innerHTML = h;
        const pp = document.getElementById('pp_source_bank'); if(pp) pp.innerHTML = h;
    }
    function getBankOptions(selectedBank) {
        let opts = db.b.map(b => `<option value="${b.name}" ${b.name===selectedBank?'selected':''}>${b.name}</option>`).join('');
        if(selectedBank === PREPAID_KEY) opts += `<option value="${PREPAID_KEY}" selected>ğŸ”´ é ä»˜æ‰£æ¬¾</option>`;
        return opts;
    }
    function toggleCardInputs(){ const t=document.getElementById('b_type').value; document.querySelectorAll('.card-only').forEach(e=>e.classList.toggle('hidden',t!='credit')); document.querySelectorAll('.bank-only').forEach(e=>e.classList.toggle('hidden',t=='credit')); }
    
    function addSubRow(v='',c='',s='æœªæ”¯ä»˜',b='',n=''){
        const d=document.createElement('div'); d.className='sub-grid'; d.style.marginBottom='5px';
        const bankOpts = db.b.map(bank => `<option value="${bank.name}" ${bank.name===b?'selected':''}>${bank.name}</option>`).join('') + 
                         `<option value="${PREPAID_KEY}" ${b===PREPAID_KEY?'selected':''}>ğŸ”´ é ä»˜æ‰£æ¬¾</option>`;
        d.innerHTML=`<input class="sv" value="${v}" list="vlist" placeholder="å» å•†" onchange="checkVendorPrepaidStatus(this)" onblur="checkVendorPrepaidStatus(this)"><input type="number" class="sc" value="${c}" placeholder="é‡‘é¡"><select class="ss"><option ${s=='æœªæ”¯ä»˜'?'selected':''}>æœªæ”¯ä»˜</option><option ${s=='å·²æ”¯ä»˜'?'selected':''}>å·²æ”¯ä»˜</option></select><select class="sb">${bankOpts}</select><input class="sn" value="${n}" placeholder="å‚™è¨»"><button type="button" class="btn btn-danger btn-sm" onclick="this.parentElement.remove()">X</button>`;
        document.getElementById('sub_area').appendChild(d);
        if(v) checkVendorPrepaidStatus(d.querySelector('.sv'));
    }
    
    function addContactRow(name='', phone='', line='') {
        const d = document.createElement('div'); d.className = 'form-grid contact-row'; d.style.marginBottom = '5px';
        d.innerHTML = `<input class="c-name" value="${name}" placeholder="è¯çµ¡äººå§“å"><input class="c-phone" value="${phone}" placeholder="è¯çµ¡é›»è©±/åˆ†æ©Ÿ"><input class="c-line" value="${line}" placeholder="Line ID"><button type="button" class="btn btn-danger btn-sm" onclick="this.parentElement.remove()">X</button>`;
        document.getElementById('contact_area').appendChild(d);
    }

    function checkAndAddParty(n,t){if(!n)return;if(!db.p.some(p=>p.name==n&&p.type==t))db.p.push({id:Date.now(),name:n,type:t,prepaid:0,isPrepaid:false});renderParties();}
    function calcNext(s,p,d){let dt=new Date(s),y=dt.getFullYear(),m=dt.getMonth();if(p=='monthly'){m++;if(m>11){m=0;y++}}else{y++}return new Date(y,m,d).toISOString().slice(0,10);}
    function calcPrev(s,p,d){let dt=new Date(s),y=dt.getFullYear(),m=dt.getMonth();if(p=='monthly'){m--;if(m<0){m=11;y--}}else{y--}let n=new Date(y,m,d);if(n.getMonth()!=m)n=new Date(y,m+1,0);return n.toISOString().split('T')[0];}
    function getNext5(s,p,d,e){let arr=[],c=s;for(let i=0;i<5;i++){if(c>e)break;arr.push(c);c=calcNext(c,p,d)}return arr;}
    
    function saveParty(){
        if (!confirm('ç¢ºå®šè¦å„²å­˜åå–®å—ï¼Ÿ')) return;
        const id=document.getElementById('p_edit_id').value; const contacts = [];
        document.querySelectorAll('.contact-row').forEach(row => { const n = row.querySelector('.c-name').value.trim(); const p = row.querySelector('.c-phone').value.trim(); const l = row.querySelector('.c-line').value.trim(); if(n || p || l) contacts.push({ n, p, l }); });
        const p = { id: id ? Number(id) : Date.now(), type: document.getElementById('p_type').value, name: document.getElementById('p_name').value, tax: document.getElementById('p_tax').value, address: document.getElementById('p_address').value, note: document.getElementById('p_note').value, contacts: contacts, contact: contacts.length > 0 ? contacts[0].n : '', phone: contacts.length > 0 ? contacts[0].p : '' };
        
        p.isPrepaid = document.getElementById('p_is_prepaid').checked;

        if(id) { let old = db.p.find(x=>x.id==id); p.prepaid = old.prepaid || 0; db.p[db.p.findIndex(x=>x.id==id)]=p; } else { p.prepaid=0; db.p.push(p); }
        document.getElementById('partyForm').reset(); document.getElementById('contact_area').innerHTML=''; document.getElementById('p_edit_id').value=''; save();
    }
    
    function renderParties(){
        const k = document.getElementById('s_key_p') ? document.getElementById('s_key_p').value.toLowerCase() : '';
        const filterFunc = p => {
            let basicMatch = (p.name + (p.tax||'') + (p.address||'') + (p.note||'')).toLowerCase().includes(k);
            if (basicMatch) return true;
            if (p.contacts && Array.isArray(p.contacts)) return p.contacts.some(c => (c.n + c.p + c.l).toLowerCase().includes(k));
            return ((p.contact||'') + (p.phone||'')).toLowerCase().includes(k);
        };
        const renderTable = (type) => db.p.filter(p => p.type == type && filterFunc(p)).map(p => 
            `<tr><td class="hover-info" onmouseenter="showPartyPreview('${p.name}','${type}',event)" onmouseleave="hidePartyPreview()"><b>${p.name}</b>${p.isPrepaid?'<span class="prepaid-badge">é ä»˜</span>':''} ${p.note ? '<span style="color:orange">â—</span>' : ''}</td><td><button class="btn btn-sm btn-warning" onclick="showStmt(${p.id})">å°å¸³</button> <button class="btn btn-sm btn-primary" onclick="editP(${p.id})">ç·¨</button> <button class="btn btn-sm btn-danger" onclick="del('p',${p.id})">åˆª</button></td></tr>`
        ).join('');
        document.getElementById('c_table').querySelector('tbody').innerHTML = renderTable('c'); 
        document.getElementById('v_table').querySelector('tbody').innerHTML = renderTable('v'); 
        document.getElementById('clist').innerHTML=db.p.filter(x=>x.type=='c').map(x=>`<option value="${x.name}">`).join(''); 
        document.getElementById('vlist').innerHTML=db.p.filter(x=>x.type=='v').map(x=>`<option value="${x.name}">`).join('');
    }
    
    let currentPid=null;
    function showStmt(id){
        currentPid = Number(id); document.getElementById('statementModal').style.display='flex';
        let d = new Date(); document.getElementById('modal_start').value = new Date(d.getFullYear(), d.getMonth(), 1).toISOString().split('T')[0]; document.getElementById('modal_end').value = new Date(d.getFullYear(), d.getMonth()+1, 0).toISOString().split('T')[0];
        const p = db.p.find(x => x.id == currentPid); const filterSel = document.getElementById('modal_filter'); filterSel.innerHTML = '';
        if(p && p.type === 'c'){ filterSel.innerHTML = `<option value="all">å…¨éƒ¨é¡¯ç¤º</option><option value="unpaid" selected>æœªçµæ¸… (å«è¨‚é‡‘)</option><option value="paid">å·²çµæ¸…</option>`; } 
        else { filterSel.innerHTML = `<option value="all">å…¨éƒ¨é¡¯ç¤º</option><option value="unpaid" selected>æœªä»˜æ¬¾</option><option value="paid">å·²ä»˜æ¬¾</option>`; }
        refreshStatement();
    }
    function closeModal(){document.getElementById('statementModal').style.display='none';}
    
    function updateStmtBank(el, type, id, subIdx) {
        let newBank = el.value, oldBank = "", amount = 0, isPaid = false, note = "";
        if(type === 'o_main') {
            let o = db.o.find(x => x.id == id); oldBank = o.bank; o.bank = newBank; isPaid = (o.pay === 'å·²æ”¶å…¨æ¬¾' || o.pay === 'å·²æ”¶è¨‚é‡‘'); amount = (o.pay === 'å·²æ”¶å…¨æ¬¾') ? safeNum(o.price) : safeNum(o.deposit); note = `[è½‰å¸³] ${o.proj} (æ›´æ›æ”¶æ¬¾éŠ€è¡Œ)`;
        } else if (type === 'o_sub') {
            let o = db.o.find(x => x.id == id); let sub = o.subs[subIdx]; oldBank = sub.b; 
            if(oldBank === PREPAID_KEY) { alert("æ­¤é …ç›®ç›®å‰ç‚ºé ä»˜æ‰£æ¬¾ï¼Œè«‹è‡³è¨‚å–®ç·¨è¼¯é é¢ä¿®æ”¹ã€‚"); refreshStatement(); return; }
             if (newBank === PREPAID_KEY) { alert("è«‹é€²å…¥è¨‚å–®ç·¨è¼¯æ¨¡å¼ä¾†ä½¿ç”¨é ä»˜æ‰£æ¬¾åŠŸèƒ½ï¼Œä»¥ç¢ºä¿é¤˜é¡æ­£ç¢ºæ‰£é™¤ã€‚"); refreshStatement(); return; }
            sub.b = newBank; isPaid = (sub.s === 'å·²æ”¯ä»˜'); amount = -safeNum(sub.c); note = `[è½‰å¸³] ${sub.v} - ${o.proj} (æ›´æ›ä»˜æ¬¾éŠ€è¡Œ)`;
        } else if (type === 'e') {
            let e = db.e.find(x => x.id == id); oldBank = e.bank; e.bank = newBank; isPaid = (e.status === 'å·²æ”¯ä»˜'); amount = -safeNum(e.amt); note = `[è½‰å¸³] ${e.note} (æ›´æ›ä»˜æ¬¾éŠ€è¡Œ)`;
        }
        if (isPaid && oldBank !== newBank) { updateBank(oldBank, -amount, note + " è½‰å‡º"); updateBank(newBank, amount, note + " è½‰å…¥"); alert(`å·²å°‡æ¬¾é …å¾ ${oldBank} ç§»è½‰è‡³ ${newBank}`); }
        save(); renderAll();
    }

    function toggleStmtStatus(type, id, subIdx) {
        try {
            if(!confirm('ç¢ºå®šè¦è®Šæ›´æ”¶æ¬¾/ä»˜æ¬¾ç‹€æ…‹å—ï¼Ÿ\n(è³‡é‡‘/é¤˜é¡å°‡è‡ªå‹•é€£å‹•)')) return;
            if (type === 'o_main') {
                let o = db.o.find(x => x.id == id); if (!o) return;
                let price = safeNum(o.price), deposit = safeNum(o.deposit);
                if (o.pay === 'å·²æ”¶å…¨æ¬¾') { updateBank(o.bank, -price, `[åæ‚”é€€] ${o.proj}`); o.pay = 'æœªæ”¶æ¬¾'; } 
                else if (o.pay === 'å·²æ”¶è¨‚é‡‘') { let bal = price - deposit; updateBank(o.bank, bal, `[å°å¸³æ”¶] ${o.proj} (å°¾æ¬¾)`); o.pay = 'å·²æ”¶å…¨æ¬¾'; } 
                else { updateBank(o.bank, price, `[å°å¸³æ”¶] ${o.proj}`); o.pay = 'å·²æ”¶å…¨æ¬¾'; }
            } else if (type === 'o_sub') {
                let o = db.o.find(x => x.id == id); if (!o || !o.subs[subIdx]) return;
                let sub = o.subs[subIdx], cost = safeNum(sub.c);
                let p = db.p.find(x => x.name === sub.v && x.type === 'v');
                let isPrepaidVendor = (p && p.isPrepaid);
                
                if(sub.b === PREPAID_KEY) {
                    if(p) {
                        if (sub.s === 'å·²æ”¯ä»˜') { p.prepaid = Number(p.prepaid) + cost; sub.s = 'æœªæ”¯ä»˜'; } 
                        else { p.prepaid = Number(p.prepaid) - cost; sub.s = 'å·²æ”¯ä»˜'; } 
                    } else { alert("æ‰¾ä¸åˆ°è©²å» å•†è³‡æ–™ï¼Œç„¡æ³•æ“ä½œé ä»˜é¤˜é¡"); return; }
                } else {
                    if(isPrepaidVendor && sub.s !== 'å·²æ”¯ä»˜') {
                        if(confirm(`å» å•† [${sub.v}] è¨­å®šç‚ºé ä»˜å» å•†ã€‚æ˜¯å¦å¾é ä»˜é¤˜é¡æ‰£æ¬¾ï¼Ÿ`)) {
                            sub.b = PREPAID_KEY;
                            p.prepaid = Number(p.prepaid) - cost;
                            sub.s = 'å·²æ”¯ä»˜';
                        } else {
                             let bank = sub.b || db.b[0]?.name;
                             updateBank(bank, -cost, `[å°å¸³ä»˜] ${sub.v} - ${o.proj}`); sub.s = 'å·²æ”¯ä»˜';
                        }
                    } else {
                        let bank = sub.b || db.b[0]?.name;
                        if (sub.s === 'å·²æ”¯ä»˜') { updateBank(bank, cost, `[åæ‚”é€€] ${sub.v} - ${o.proj}`); sub.s = 'æœªæ”¯ä»˜'; } 
                        else { updateBank(bank, -cost, `[å°å¸³ä»˜] ${sub.v} - ${o.proj}`); sub.s = 'å·²æ”¯ä»˜'; }
                    }
                }
            } else if (type === 'e') {
                let e = db.e.find(x => x.id == id); if (!e) return;
                let amt = safeNum(e.amt);
                if (e.status === 'å·²æ”¯ä»˜') { updateBank(e.bank, amt, `[åæ‚”é€€] ${e.note}`); e.status = 'æœªæ”¯ä»˜'; } 
                else { updateBank(e.bank, -amt, `[å°å¸³ä»˜] ${e.note}`); e.status = 'å·²æ”¯ä»˜'; }
            }
            save(); refreshStatement(); renderAll(); 
        } catch(err) { console.error(err); alert("å°å¸³æ“ä½œå¤±æ•—ï¼Œè«‹å˜—è©¦é‡æ•´é é¢"); }
    }

    function refreshStatement(){
        const p = db.p.find(x => x.id == currentPid); if(!p) { alert("æ‰¾ä¸åˆ°è©²åå–®è³‡æ–™"); return; } 
        const s = document.getElementById('modal_start').value, e = document.getElementById('modal_end').value;
        const filterVal = document.getElementById('modal_filter').value;
        document.getElementById('modal_title').innerText = (p.type=='c'?'æ”¶æ¬¾å°å¸³ - ':'ä»˜æ¬¾å°å¸³ - ') + p.name;
        document.getElementById('modal_info').innerText = `${s} ~ ${e}`;
        let h = '', t = 0, pd = 0;

        if(p.type == 'c'){
            db.o.filter(o => o.cust == p.name && o.date >= s && o.date <= e).forEach(o => {
                if(filterVal === 'unpaid' && o.pay === 'å·²æ”¶å…¨æ¬¾') return; if(filterVal === 'paid' && o.pay !== 'å·²æ”¶å…¨æ¬¾') return;
                let price = safeNum(o.price), paid = 0, statusClass = 'st-unpaid';
                if(o.pay == 'å·²æ”¶å…¨æ¬¾') { paid = price; statusClass = 'st-paid'; } else if(o.pay == 'å·²æ”¶è¨‚é‡‘') { paid = safeNum(o.deposit); statusClass = 'st-deposit'; }
                t += price; pd += paid;
                h += `<tr><td>${o.date}</td><td>${o.proj} ${o.invNum ? '<br><small>('+o.invNum+')</small>' : ''}</td><td>$${price.toLocaleString()}</td><td><select class="stmt-bank-sel" onchange="updateStmtBank(this, 'o_main', ${o.id})">${getBankOptions(o.bank)}</select> <button class="status-btn ${statusClass}" onclick="toggleStmtStatus('o_main', ${o.id})">${o.pay}</button></td></tr>`;
            });
        } else {
            db.o.forEach(o => {
                if(o.subs && Array.isArray(o.subs)){
                    o.subs.forEach((sb, idx) => {
                        if(sb.v == p.name && o.date >= s && o.date <= e){
                            if(filterVal === 'unpaid' && sb.s === 'å·²æ”¯ä»˜') return; if(filterVal === 'paid' && sb.s !== 'å·²æ”¯ä»˜') return;
                            let cost = safeNum(sb.c); t += cost; let statusClass = 'st-unpaid';
                            if(sb.s == 'å·²æ”¯ä»˜') { pd += cost; statusClass = 'st-paid'; }
                            let bankDisplay = sb.b === PREPAID_KEY ? 'ğŸ”´é ä»˜' : getBankOptions(sb.b);
                            let bankInput = sb.b === PREPAID_KEY ? `<span style="font-size:12px; font-weight:bold; color:#c2410c;">ğŸ”´ é ä»˜æ‰£æ¬¾</span>` : `<select class="stmt-bank-sel" onchange="updateStmtBank(this, 'o_sub', ${o.id}, ${idx})">${bankDisplay}</select>`;
                            h += `<tr><td>${o.date}</td><td>[åŒ…] ${o.proj}</td><td>$${cost.toLocaleString()}</td><td>${bankInput} <button class="status-btn ${statusClass}" onclick="toggleStmtStatus('o_sub', ${o.id}, ${idx})">${sb.s}</button></td></tr>`;
                        }
                    });
                }
            });
            db.e.filter(x => x.target == p.name && x.date >= s && x.date <= e).forEach(x => {
                if(filterVal === 'unpaid' && x.status === 'å·²æ”¯ä»˜') return; if(filterVal === 'paid' && x.status !== 'å·²æ”¯ä»˜') return;
                let amt = safeNum(x.amt); t += amt; let statusClass = 'st-unpaid';
                if(x.status == 'å·²æ”¯ä»˜') { pd += amt; statusClass = 'st-paid'; }
                h += `<tr><td>${x.date}</td><td>[æ”¯] ${x.note}</td><td>$${amt.toLocaleString()}</td><td><select class="stmt-bank-sel" onchange="updateStmtBank(this, 'e', ${x.id})">${getBankOptions(x.bank)}</select> <button class="status-btn ${statusClass}" onclick="toggleStmtStatus('e', ${x.id})">${x.status}</button></td></tr>`;
            });
        }
        document.getElementById('modal_table').innerHTML = `<thead><tr><th>æ—¥æœŸ</th><th>é …ç›®</th><th>æ‡‰${p.type=='c'?'æ”¶':'ä»˜'}</th><th>ç‹€æ…‹ / éŠ€è¡Œ (é»æ“Šè®Šæ›´)</th></tr></thead><tbody>${h || '<tr><td colspan=4>ç„¡ç¬¦åˆè³‡æ–™</td></tr>'}</tbody>`;
        let balance = t - pd;
        
        let prepaidInfo = '';
        if(p.type === 'v') {
             let pp = Number(p.prepaid) || 0;
             prepaidInfo = ` | <span style="color:${pp>=0?'#059669':'#ef4444'}">ç¾æœ‰é ä»˜é¤˜é¡: $${pp.toLocaleString()}</span>`;
        }

        document.getElementById('modal_summary').innerHTML = `ç¸½é‡‘é¡: $${t.toLocaleString()} | å·²çµæ¸…: $${pd.toLocaleString()} | æœªçµæ¸…: $${balance.toLocaleString()}${prepaidInfo}`;
    }

    function editO(id){
        const o=db.o.find(x=>x.id==id);
        document.getElementById('o_edit_id').value=o.id; document.getElementById('o_date').value=o.date; document.getElementById('o_proj').value=o.proj;
        document.getElementById('o_cust').value=o.cust; 
        document.getElementById('o_contact').value = o.contact || '';
        document.getElementById('o_phone').value = o.phone || '';
        document.getElementById('o_addr').value = o.addr || '';
        document.getElementById('o_invoice').value=o.invoice; document.getElementById('o_inv_num').value=o.invNum||''; 
        document.getElementById('o_price').value=o.price; document.getElementById('o_base').value=o.base; document.getElementById('o_tax').value=o.tax;
        document.getElementById('o_deposit').value=o.deposit; document.getElementById('o_inv').value=o.inv; document.getElementById('o_pay').value=o.pay;
        document.getElementById('o_bank').value=o.bank; document.getElementById('o_note').value=o.note||'';
        
        document.getElementById('items_area').innerHTML = '';
        if(o.items && Array.isArray(o.items)) {
            o.items.forEach(i => addItemRow(i.name, i.spec, i.w, i.h, i.t, i.qty, i.price, i.total));
        }

        document.getElementById('sub_area').innerHTML=''; o.subs.forEach(s=>addSubRow(s.v,s.c,s.s,s.b,s.n));
        switchTab('orders'); document.getElementById('orderForm').scrollIntoView({ behavior: 'smooth' });
    }
    function editE(id){
        const e=db.e.find(x=>x.id==id);
        document.getElementById('e_edit_id').value=e.id; document.getElementById('e_date').value=e.date; document.getElementById('e_note').value=e.note;
        document.getElementById('e_target').value=e.target; document.getElementById('e_amt').value=e.amt; document.getElementById('e_bank').value=e.bank;
        document.getElementById('e_status').value=e.status; document.getElementById('e_remark').value=e.remark||'';
        switchTab('expenses'); document.getElementById('expForm').scrollIntoView({ behavior: 'smooth' });
    }
    function editR(id){
        const r=db.r.find(x=>x.id==id);
        document.getElementById('r_edit_id').value=r.id; document.getElementById('r_title').value=r.title; document.getElementById('r_amt').value=r.amt;
        document.getElementById('r_bank').value=r.bank; document.getElementById('r_period').value=r.period; document.getElementById('r_cycle_val').value=r.cycleVal;
        document.getElementById('r_start').value=r.start; document.getElementById('r_end').value=r.end; document.getElementById('r_note').value=r.note||'';
        document.getElementById('recurForm').scrollIntoView({ behavior: 'smooth' });
    }
    function editP(id){
        const p=db.p.find(x=>x.id==id); document.getElementById('p_edit_id').value=p.id; document.getElementById('p_type').value=p.type; document.getElementById('p_name').value=p.name; document.getElementById('p_tax').value=p.tax; document.getElementById('p_address').value = p.address || ''; document.getElementById('p_note').value = p.note || '';
        document.getElementById('p_is_prepaid').checked = p.isPrepaid || false;
        document.getElementById('contact_area').innerHTML = ''; if (p.contacts && Array.isArray(p.contacts) && p.contacts.length > 0) { p.contacts.forEach(c => addContactRow(c.n, c.p, c.l)); } else if (p.contact || p.phone) { addContactRow(p.contact || '', p.phone || '', ''); }
        document.getElementById('partyForm').scrollIntoView({ behavior: 'smooth' });
    }
    
// â˜…â˜…â˜… ä¿®æ”¹å¾Œçš„åˆªé™¤å‡½å¼ (é…åˆå¤šäººé˜²è¡çªç‰ˆ) â˜…â˜…â˜…
    function del(t, id){
        if(!confirm('âš ï¸ ç¢ºå®šè¦æ°¸ä¹…åˆªé™¤æ­¤ç­†è³‡æ–™å—ï¼Ÿ(æ­¤å‹•ä½œç„¡æ³•å¾©åŸ)')) return;
        
        // 1. å…ˆè™•ç†ç‰¹æ®Šé‚è¼¯ (å¦‚: åˆªé™¤æ”¯å‡ºè¦å›è£œé‡‘é¡)
        if(t=='e'){
            let e=db.e.find(x=>x.id==id);
            if(e){
                if(e.status=='å·²æ”¯ä»˜'){ let b=db.b.find(x=>x.name==e.bank); if(b&&b.type!='credit') updateBank(e.bank,e.amt,'[é€€]'+e.note); }
                if(e.linkId){ let r=db.r.find(x=>x.id==e.linkId); if(r && confirm('é€™æ˜¯å›ºå®šæ”¯å‡ºè²»ç”¨ï¼Œæ˜¯å¦å°‡åˆç´„æ—¥æœŸå€’å›ä¸Šä¸€æœŸï¼Ÿ')){ r.nextDate=calcPrev(r.nextDate,r.period,r.cycleVal); } }
            }
            db.e=db.e.filter(x=>x.id!=id);
        } else {
            if(t=='o'){ 
                let o=db.o.find(x=>x.id==id); 
                if(o && o.subs) { 
                    o.subs.forEach(s => { 
                        if(s.s === 'å·²æ”¯ä»˜' && s.b === PREPAID_KEY) { 
                            let p = db.p.find(px=>px.name===s.v && px.type==='v'); 
                            if(p) p.prepaid = Number(p.prepaid) + s.c; 
                        }
                    }); 
                }
                db.o=db.o.filter(x=>x.id!=id); 
            }
            if(t=='r')db.r=db.r.filter(x=>x.id!=id); 
            if(t=='p')db.p=db.p.filter(x=>x.id!=id); 
            if(t=='b')db.b=db.b.filter(x=>x.id!=id);
        }

        // 2. æ›´æ–°ç•«é¢
        renderAll();

        // 3. â˜… ç™¼é€å°ˆç”¨åˆªé™¤æŒ‡ä»¤çµ¦é›²ç«¯ (å–ä»£ save()) â˜…
        toggleLoading(true, "æ­£åœ¨åˆªé™¤é›²ç«¯è³‡æ–™...");
        fetch(API_URL, {
            method: 'POST',
            mode: 'no-cors',
            body: JSON.stringify({
                action: 'delete_item',
                type: t,  // å‘Šè¨´é›²ç«¯è¦åˆªé™¤å“ªå€‹é¡åˆ¥ (o=è¨‚å–®, e=æ”¯å‡º...)
                id: id    // å‘Šè¨´é›²ç«¯è¦åˆªé™¤å“ªå€‹ ID
            })
        }).then(() => {
            toggleLoading(false);
            // ä¸ç”¨ alertï¼Œé¿å…å¹²æ“¾æ“ä½œ
        }).catch(err => {
            alert("åˆªé™¤å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯ï¼");
            toggleLoading(false);
        });
    }
    function hardReset(){if(confirm('æ¸…é™¤æ‰€æœ‰è³‡æ–™?')) {localStorage.clear(); location.reload();}}
    function switchTab(id){document.querySelectorAll('.tab-content,.tab-btn').forEach(e=>e.classList.remove('active'));document.querySelector(`[onclick="switchTab('${id}')"]`).classList.add('active');document.getElementById(id).classList.add('active'); if(id=='reports') renderReports();}
    function renderAll(){updateBankSelects();renderOrders();renderExpenses();renderRecurring();renderBanks();renderParties();
        let rev=0,cost=0,ar=0,ap=0,vi=0,vo=0,tm=new Date().toISOString().slice(0,7);
        db.o.forEach(o=>{if(o.date.startsWith(tm)){rev+=o.base||0;vo+=o.tax||0} if(o.pay=='æœªæ”¶æ¬¾')ar+=o.price||0;else if(o.pay=='å·²æ”¶è¨‚é‡‘')ar+=(o.price-o.deposit)||0; o.subs.forEach(s=>{if(s.s=='æœªæ”¯ä»˜')ap+=s.c||0})});
        db.e.forEach(e=>{if(e.date.startsWith(tm)){cost+=e.base||0;vi+=e.tax||0} if(e.status=='æœªæ”¯ä»˜')ap+=e.amt||0});
        document.getElementById('kpi_cash').innerText='$'+safeNum(rev-cost).toLocaleString();
        document.getElementById('kpi_vat').innerText='$'+safeNum(vo-vi).toLocaleString();
        document.getElementById('kpi_ar').innerText='$'+safeNum(ar).toLocaleString();
        document.getElementById('kpi_ap').innerText='$'+safeNum(ap).toLocaleString();
    }
    function exportData(){const d="data:text/json;charset=utf-8,"+encodeURIComponent(JSON.stringify(db));const a=document.createElement('a');a.href=d;a.download="ERP_Backup_V785.json";document.body.appendChild(a);a.click();a.remove();}
 // ERP ç³»çµ±å°ˆç”¨
async function importData(input) {
    const f = input.files[0];
    if(!f) return;
    const r = new FileReader();
    r.onload = async function(e) {
        try {
            const allData = JSON.parse(e.target.result);
            if(!confirm("âš ï¸ é€™å°‡è¦†è“‹é›²ç«¯æ‰€æœ‰è³‡æ–™ï¼Œç¢ºå®šåŸ·è¡Œï¼Ÿ")) return;
            
            toggleLoading(true, "æ­£åœ¨åŸ·è¡Œå…¨é‚„åŸ...");
            
            await fetch(API_URL, {
                method: 'POST',
                // é€™è£¡æ”¹ç”¨ FULL_RESTORE é…åˆæ–°çš„ GAS
                body: JSON.stringify({ action: 'FULL_RESTORE', allData: allData })
            });
            
            alert('âœ… é‚„åŸæˆåŠŸï¼');
            location.reload(); // é‡æ–°æ•´ç†ä»¥è®€å–æ–°è³‡æ–™
        } catch(err) {
            alert('âŒ é‚„åŸå¤±æ•—ï¼š' + err);
            toggleLoading(false);
        }
    };
    r.readAsText(f);
    input.value = '';
}
// â˜…â˜…â˜… è¶…å¼·ç‰ˆï¼šè‡ªå®šç¾©æ¬„ä½åŒ¯å‡º Excel â˜…â˜…â˜…
    function exportExcel() {
        if (!db.o || db.o.length === 0) {
            alert("ç›®å‰æ²’æœ‰è³‡æ–™å¯ä»¥åŒ¯å‡ºï¼");
            return;
        }

        // ==========================================
        // â–¼â–¼â–¼ è¨­å®šå€ï¼šæ‚¨æƒ³è¦åŒ¯å‡ºå“ªäº›æ¬„ä½ï¼Ÿè«‹åœ¨é€™è£¡èª¿æ•´ â–¼â–¼â–¼
        // header: Excel ä¸Šé¢é¡¯ç¤ºçš„æ¨™é¡Œ
        // value: è³‡æ–™å…§å®¹ (o ä»£è¡¨è©²ç­†è¨‚å–®)
        // ==========================================
        const columns = [
            { header: "æ—¥æœŸ",       value: o => o.date },
            { header: "å–®è™Ÿ",       value: o => o.id },
            { header: "å®¢æˆ¶åç¨±",   value: o => o.cust },
            { header: "å°ˆæ¡ˆåç¨±",   value: o => o.title },
            
            // â˜… æ‚¨æŒ‡å®šçš„ç™¼ç¥¨æ¬„ä½ (ç³»çµ±å˜—è©¦è®€å– inv æˆ– invoice æ¬„ä½)
            { header: "ç™¼ç¥¨è™Ÿç¢¼",   value: o => o.inv || o.invoice || "" }, 
            
            // â˜… è‡ªå‹•æ‹†ç®—ç¨…é¡ (ç¸½é¡ / 1.05 = æœªç¨…)
            { header: "æœªç¨…é‡‘é¡",   value: o => Math.round((safeNum(o.price)||0) / 1.05) },
            { header: "ç¨…é‡‘(5%)",   value: o => (safeNum(o.price)||0) - Math.round((safeNum(o.price)||0) / 1.05) },
            { header: "å«ç¨…ç¸½é¡",   value: o => safeNum(o.price) || 0 },
            
            { header: "æ”¶æ¬¾ç‹€æ…‹",   value: o => o.status || "æœªæ”¶æ¬¾" },
            { header: "æˆæœ¬æ”¯å‡º",   value: o => safeNum(o.cost) || 0 },
            { header: "æ¯›åˆ©",       value: o => (safeNum(o.price)||0) - (safeNum(o.cost)||0) },
            { header: "å‚™è¨»",       value: o => o.note || "" }
        ];
        // â–²â–²â–² è¨­å®šå€çµæŸ â–²â–²â–²

        // 1. æº–å‚™ CSV å…§å®¹ (åŠ å…¥ BOM é˜²æ­¢äº‚ç¢¼)
        let csvContent = "\uFEFF"; 
        
        // 2. ç”¢ç”Ÿæ¨™é¡Œåˆ—
        csvContent += columns.map(c => c.header).join(",") + "\n";

        // 3. æ’åºè³‡æ–™ (æ—¥æœŸç”±æ–°åˆ°èˆŠ)
        let sortedOrders = db.o.slice().sort((a, b) => new Date(b.date) - new Date(a.date));

        // 4. ç”¢ç”Ÿå…§å®¹
        sortedOrders.forEach(o => {
            let row = columns.map(col => {
                // å–å¾—æ•¸å€¼
                let val = col.value(o);
                
                // è³‡æ–™æ¸…ç† (é¿å…é€—è™Ÿã€æ›è¡Œç ´å£æ ¼å¼)
                if (val === null || val === undefined) val = "";
                val = val.toString().replace(/"/g, '""').replace(/,/g, 'ï¼Œ').replace(/\n/g, ' ');
                
                return `"${val}"`; // å¼·åˆ¶ç”¨å¼•è™ŸåŒ…èµ·ä¾†ï¼Œé¿å…æ ¼å¼è·‘æ‰
            }).join(",");
            
            csvContent += row + "\n";
        });

        // 5. ä¸‹è¼‰æª”æ¡ˆ
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const link = document.createElement("a");
        const fileName = `å®Œæ•´å¸³å‹™å ±è¡¨_${new Date().toISOString().slice(0,10)}.csv`;
        
        link.setAttribute("href", url);
        link.setAttribute("download", fileName);
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }
</script>
</body>
</html>